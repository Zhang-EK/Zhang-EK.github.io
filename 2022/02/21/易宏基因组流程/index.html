<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="folk的微生物所刘永鑫写的基本宏基因组分析流程">
<meta property="og:type" content="article">
<meta property="og:title" content="易宏基因组流程">
<meta property="og:url" content="http://example.com/2022/02/21/%E6%98%93%E5%AE%8F%E5%9F%BA%E5%9B%A0%E7%BB%84%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="ZEK&amp;YL&#39;s blog">
<meta property="og:description" content="folk的微生物所刘永鑫写的基本宏基因组分析流程">
<meta property="og:locale">
<meta property="article:published_time" content="2022-02-21T00:00:00.000Z">
<meta property="article:modified_time" content="2023-02-21T21:08:58.911Z">
<meta property="article:author" content="ZEK YL">
<meta property="article:tag" content="生物信息软件流程">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/02/21/%E6%98%93%E5%AE%8F%E5%9F%BA%E5%9B%A0%E7%BB%84%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>易宏基因组流程 | ZEK&YL's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="ZEK&YL's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ZEK&YL's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-主页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>主页</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-历史">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>历史</a>

  </li>
        <li class="menu-item menu-item-关于我们">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我们</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/21/%E6%98%93%E5%AE%8F%E5%9F%BA%E5%9B%A0%E7%BB%84%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/Zhang-EK/blog_img/main/WechatIMG22.jpeg">
      <meta itemprop="name" content="ZEK YL">
      <meta itemprop="description" content="2019.10.16">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZEK&YL's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          易宏基因组流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-21 00:00:00" itemprop="dateCreated datePublished" datetime="2022-02-21T00:00:00+00:00">2022-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-21 21:08:58" itemprop="dateModified" datetime="2023-02-21T21:08:58+00:00">2023-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/2023/" itemprop="url" rel="index"><span itemprop="name">2023</span></a>
                </span>
            </span>

          
            <div class="post-description">folk的微生物所刘永鑫写的基本宏基因组分析流程</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[TOC] </p>
<h1 id="易宏基因组流程EasyMetagenomePipeline"><a href="#易宏基因组流程EasyMetagenomePipeline" class="headerlink" title="易宏基因组流程EasyMetagenomePipeline"></a>易宏基因组流程EasyMetagenomePipeline</h1><pre><code># 版本: 1.14, 2022/3/25
# 测试环境为Linux Ubuntu 20.04 / CentOS 7.7
</code></pre>
<h1 id="一、数据预处理-Data-preprocessing"><a href="#一、数据预处理-Data-preprocessing" class="headerlink" title="一、数据预处理 Data preprocessing"></a>一、数据预处理 Data preprocessing</h1><h2 id="1-1-准备工作-Prepare"><a href="#1-1-准备工作-Prepare" class="headerlink" title="1.1 准备工作 Prepare"></a>1.1 准备工作 Prepare</h2><ol>
<li>首次使用请参照<code>0Install.sh</code>脚本，安装软件和数据库(大约1-3天，仅一次)</li>
<li>易宏基因组(EasyMetagenome)流程<code>1Pipeline.sh</code>复制到项目文件夹，如本次为meta</li>
<li>项目文件夹准备测序数据(seq/*.fq.gz)和样本元数据(result/metadata.txt)</li>
</ol>
<h3 id="1-1-1-环境变量设置-每次开始分析前必须运行"><a href="#1-1-1-环境变量设置-每次开始分析前必须运行" class="headerlink" title="1.1.1 环境变量设置(每次开始分析前必须运行)"></a>1.1.1 环境变量设置(每次开始分析前必须运行)</h3><p>设置数据库、软件和工作目录</p>
<pre><code># Conda软件software安装目录，`conda env list`命令查看，如~/miniconda3
soft=/conda2
# 公共数据库database(db)位置，如管理员设置/db，个人下载至~/db，并添加其中linux目录中程序至环境变量
db=/db
# 设置工作目录work directory(wd)，如meta
wd=~/meta

# 添加分析所需的软件、脚本至环境变量，添加至~/.bashrc中自动加载
PATH=$db/EasyMicrobiome/linux:$db/EasyMicrobiome/script:$PATH
# 创建并进入工作目录
mkdir -p $wd &amp;&amp; cd $wd

# 指定某个R语言环境(可选windows下本地运行)
alias Rscript=&quot;/anaconda2/bin/Rscript --vanilla&quot;
</code></pre>
<h3 id="1-1-2-起始文件——序列和元数据"><a href="#1-1-2-起始文件——序列和元数据" class="headerlink" title="1.1.2 起始文件——序列和元数据"></a>1.1.2 起始文件——序列和元数据</h3><pre><code># 创建3个常用子目录：序列，临时文件和结果
mkdir -p seq temp result

# 上传元数据metadata.txt至result目录，此处下载并重命名
wget http://210.75.224.110/github/EasyMetagenome/result/metadata2.txt
mv metadata2.txt result/metadata.txt
# 检查文件格式，^I为制表符，$为Linux换行，^M$为Windows回车，^M为Mac换行符
cat -A result/metadata.txt
# 转换Windows回车为Linux换行
sed -i &#39;s/\r//&#39; result/metadata.txt
cat -A result/metadata.txt
</code></pre>
<p>用户使用filezilla上传测序文件至seq目录，本次从其它位置复制，或从网络下载测试数据(多种方法任选其一)</p>
<pre><code># 方法1. 网络下载测试数据
cd seq/
awk &#39;&#123;system(&quot;wget -c http://210.75.224.110/github/EasyMetagenome/seq/&quot;$1&quot;_1.fq.gz&quot;)&#125;&#39; \
  &lt;(tail -n+2 ../result/metadata.txt)
awk &#39;&#123;system(&quot;wget -c http://210.75.224.110/github/EasyMetagenome/seq/&quot;$1&quot;_2.fq.gz&quot;)&#125;&#39; \
  &lt;(tail -n+2 ../result/metadata.txt)
cd ..

# 方法2. 从其它目录复制测序数据
# cp -rf /db/meta/seq/*.gz seq/

# 查看文件大小
ls -lsh seq
# -l 列出详细信息 (l: list)
# -sh 显示人类可读方式文件大小 (s: size; h: human readable)    
</code></pre>
<h3 id="1-1-3-了解工作目录和文件"><a href="#1-1-3-了解工作目录和文件" class="headerlink" title="1.1.3 了解工作目录和文件"></a>1.1.3 了解工作目录和文件</h3><p>显示文件结构</p>
<pre><code># Ubuntu下安装tree命令
# sudo apt install tree
# 无法安装请更新软件列表 sudo apt update
tree -L 2
# .
# ├── pipeline.sh
# ├── result
# │   └── metadata.txt
# ├── seq
# │   ├── C1_1.fq.gz
# │   ├── C1_2.fq.gz
# │   ├── N1_1.fq.gz
# │   └── N1_2.fq.gz
# └── temp
</code></pre>
<ul>
<li>1pipeline.sh是分析流程代码；</li>
<li>seq目录中有2个样本Illumina双端测序，4个序列文件；</li>
<li>temp是临时文件夹，存储分析中间文件，结束可全部删除节约空间</li>
<li>result是重要节点文件和整理化的分析结果图表，<ul>
<li>实验设计metadata.txt也在此</li>
</ul>
</li>
</ul>
<h2 id="1-2-可选-FastQC质量评估"><a href="#1-2-可选-FastQC质量评估" class="headerlink" title="1.2 (可选)FastQC质量评估"></a>1.2 (可选)FastQC质量评估</h2><pre><code># (可选)使用指定位置的(别人安装的)conda
source /home/liuyongxin/miniconda2/bin/activate
# 启动软件环境
conda activate meta
# 第一次使用软件要记录软件版本，文章方法中必须写清楚
fastqc --version # 0.11.9
# time统计运行时间，fastqc质量评估
# *.gz为原始数据，-t指定多线程
time fastqc seq/*.gz -t 2
</code></pre>
<p>质控报告见<code>seq</code>目录，详细解读请阅读<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/tDMih7ISLJcL4F4sWBq3Vw">《数据的质量控制软件——FastQC》</a>。</p>
<p>multiqc将fastqc的多个报告生成单个整合报告，方法批量查看和比较</p>
<pre><code># 记录软件版本
multiqc --version # 1.8
# 整理seq目录下fastqc报告，输出multiqc_report.html至result/qc目录
multiqc -d seq/ -o result/qc
</code></pre>
<p>查看右侧result/qc目录中multiqc_report.html，单击，选择<code>View in Web Browser</code>查看可交互式报告。</p>
<h2 id="1-3-质量控制"><a href="#1-3-质量控制" class="headerlink" title="1.3 质量控制"></a>1.3 质量控制</h2><pre><code>mkdir -p temp/qc
</code></pre>
<h3 id="1-3-1-Fastp质量控制环境样品"><a href="#1-3-1-Fastp质量控制环境样品" class="headerlink" title="1.3.1 Fastp质量控制环境样品"></a>1.3.1 Fastp质量控制环境样品</h3><p>适用于无宿主污染的环境样品，质控速度快，自动识别接头和低质量，详见：<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s/u3U-AJW7oRYTx5h13c19UQ">极速的FASTQ文件质控+过滤+校正fastp</a></p>
<pre><code># 单样本质控
i=C1
fastp -i seq/$&#123;i&#125;_1.fq.gz -o temp/qc/$&#123;i&#125;_1.fastq -I seq/$&#123;i&#125;_2.fq.gz -O temp/qc/$&#123;i&#125;_2.fastq
 
# 多样本并行
tail -n+2 result/metadata.txt|cut -f1|rush -j 2 \
  &quot;fastp -i seq/&#123;1&#125;_1.fq.gz -o temp/qc/&#123;1&#125;_1.fastq -I seq/&#123;1&#125;_2.fq.gz -O temp/qc/&#123;1&#125;_2.fastq&quot;
</code></pre>
<h3 id="1-3-2-KneadData质控和去宿主"><a href="#1-3-2-KneadData质控和去宿主" class="headerlink" title="1.3.2 KneadData质控和去宿主"></a>1.3.2 KneadData质控和去宿主</h3><p>kneaddata是流程，它主要依赖trimmomatic质控和去接头，bowtie2比对宿主，然后筛选非宿主序列用于下游分析 。</p>
<p>详细教程和常见问题，阅读：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ovL4TwalqZvwx5qWb5fsYA">MPB：随机宏基因组测序数据质量控制和去宿主的分析流程和常见问题</a></p>
<pre><code># 记录核心软件版本
kneaddata --version # 0.7.4
trimmomatic -version # 0.39
bowtie2 --version # 2.3.5.1
# 可只选一行中部分代码点击Run，如选中下行中#号后面命令查看程序帮助
# kneaddata -h # 显示帮助
</code></pre>
<p>检查点：zless/zcat查看可压缩文件，检查序列质量格式(质量值大写字母为标准Phred33格式，小写字母为Phred64，需参考附录：质量值转换)；检查双端序列ID是否重复，如果重名需要在质控前改名更正。参考<strong>附录，质控kneaddata，去宿主后双端不匹配——序列改名</strong>。</p>
<pre><code># 设置某个样本名为变量i，以后再无需修改
i=C1
# zless查看压缩文件，空格翻页，按q退出。
zless seq/$&#123;i&#125;_1.fq.gz | head -n4
# zcat显示压缩文件，head指定显示行数
zcat seq/$&#123;i&#125;_2.fq.gz | head -n4
</code></pre>
<ul>
<li>“|” 为管道符，上一个命令的输出，传递给下一个命令做输入</li>
<li>gzip: stdout: Broken pipe：管道断开。这里是人为断开，不是错误</li>
<li>运行过程中需要仔细阅读屏幕输出的信息</li>
</ul>
<p>如果序列双端名称一致，改名参见下方代码</p>
<p>(可选) 序列改名，解决NCBI SRA数据双端ID重名问题，详见<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ovL4TwalqZvwx5qWb5fsYA">《MPB：随机宏基因组测序数据质量控制和去宿主的分析流程和常见问题》</a>。</p>
<pre><code>gunzip seq/*.gz
sed -i &#39;1~4 s/$/\\1/g&#39; seq/*_1.fq
sed -i &#39;1~4 s/$/\\2/g&#39; seq/*_2.fq
# 再次核对样本是否标签有重复
head seq/C2_1.fq
head seq/C2_2.fq
# 结果压缩节省空间
gzip seq/*.fq
# pigz是并行版的gzip，没装可使用为gzip
# pigz seq/*.fq
</code></pre>
<h4 id="可选-单样品质控"><a href="#可选-单样品质控" class="headerlink" title="(可选)单样品质控"></a>(可选)单样品质控</h4><p>若一条代码分割在多行显示时，最好全部选中运行，多行分割的代码行末有一个 “\” 。多行注释命令运行，可全选，按Ctrl+Shift+C进行注释的取消和添加。</p>
<ul>
<li>以metadata中<code>C1</code>样品本质控为例</li>
</ul>
<ol>
<li>输入文件：双端FASTQ测序数据，提供给参数-i，seq/${i}_1.fq.gz和 seq/${i}_2.fq.gz</li>
<li>参考数据库：宿主基因组索引 -db ${db}/kneaddata/human_genome/hg37dec_v0.1</li>
<li>输出文件：质控后的FASTQ测序数据，在目录temp/qc下面，${i}_1_kneaddata_paired_1.fastq和${i}_1_kneaddata_paired_1.fastq，用于后续分析</li>
<li>软件位置：<code>conda env list</code>查看软件安装位置，请务必根据自己软件和数据库安装位置，修改软件trimmomatic和接头文件位置。</li>
</ol>
<p>(可选)手动设置trimmomatic程序和接头位置</p>
<pre><code>程序目录：$&#123;soft&#125;/envs/meta/share/trimmomatic/
# 查看multiqc结果中接头污染最严重的C2_1样本，再到fastqc报告中查看接头序列，复制前20个碱基检索确定接头文件
grep &#39;AGATCGGAAGAGCGTCGTGTAGGGAAA&#39; $&#123;soft&#125;/envs/meta/share/trimmomatic/adapters/*
# 根据实际情况选择单端SE或双端PE，与原序列比较确定为 TruSeq2-PE.fa，目前多为TruSeq3-PE-2.fa，更准确的是问测序公司要接头文件
</code></pre>
<p>100万条序列8线程质控和去宿主，耗时~2m。</p>
<pre><code>i=C1
# kneaddata位于liuyongxin中的meta环境，基因组名称为Homo_sapiens或hg37dec_v0.1
# soft=/home/liuyongxin/miniconda2/
kneaddata -i seq/$&#123;i&#125;_1.fq.gz -i seq/$&#123;i&#125;_2.fq.gz \
  -o temp/qc -v -t 8 --remove-intermediate-output \
  --trimmomatic $&#123;soft&#125;/envs/meta/share/trimmomatic/ \
  --trimmomatic-options &quot;ILLUMINACLIP:$&#123;soft&#125;/envs/meta/share/trimmomatic/adapters/TruSeq2-PE.fa:2:40:15 SLIDINGWINDOW:4:20 MINLEN:50&quot; \
  --reorder --bowtie2-options &quot;--very-sensitive --dovetail&quot; \
  -db $&#123;db&#125;/kneaddata/human_genome/hg37dec_v0.1

# 查看质控后的结果文件大小，确保不是0
ls -shtr temp/qc/$&#123;i&#125;_1_kneaddata_paired_?.fastq
</code></pre>
<h4 id="多样品并行质控"><a href="#多样品并行质控" class="headerlink" title="多样品并行质控"></a>多样品并行质控</h4><p>方法1. rush并行管理：注释修改trimmomatic为绝对路径，即修改/home/liuyongxin/miniconda2为你设置的soft变量完整路径，自己用户安装的soft为~/miniconda3(注：存在单引号的代码内不支持变量)</p>
<pre><code>tail -n+2 result/metadata.txt|cut -f1|rush -j 2 \
  &quot;kneaddata -i seq/&#123;1&#125;_1.fq.gz -i seq/&#123;1&#125;_2.fq.gz \
  -o temp/qc -v -t 3 --remove-intermediate-output \
  --trimmomatic $soft/envs/meta/share/trimmomatic/ \
  --trimmomatic-options &#39;ILLUMINACLIP:/home/liuyongxin/miniconda2/envs/meta/share/trimmomatic/adapters/TruSeq2-PE.fa:2:40:15 SLIDINGWINDOW:4:20 MINLEN:50&#39; \
  --reorder --bowtie2-options &#39;--very-sensitive --dovetail&#39; \
  -db $&#123;db&#125;/kneaddata/human_genome/hg37dec_v0.1&quot;
</code></pre>
<p>(可选)方法2. parallel并行质控和去宿主</p>
<pre><code># 记录软件版本
parallel --version # 20160222
# 打will cite承诺引用并行软件parallel
parallel --citation 

# parallel软件说明和使用实例
# 根据样本列表`:::`并行处理，并行j=2个任务，每个任务t=3个线程，2~7m
# 运行下面这行，体会下parallel的工作原理
# ::: 表示传递参数；第一个::: 后面为第一组参数，对应于&#123;1&#125;;
# 第二个::: 后面为第二组参数，对应于&#123;2&#125;，依次替换
parallel -j 3 --xapply &quot;echo &#123;1&#125; &#123;2&#125;&quot; ::: seq/*_1.fq.gz ::: seq/*_2.fq.gz
# --xapply保持文件成对，否则将为两两组合，显示如下：
parallel -j 2 &quot;echo &#123;1&#125; &#123;2&#125;&quot; ::: seq/*_1.fq.gz ::: seq/*_2.fq.gz
# 从文件列表使用
parallel -j 3 --xapply &quot;echo seq/&#123;1&#125;_1.fq.gz seq/&#123;1&#125;_2.fq.gz&quot; ::: `tail -n+2 result/metadata.txt|cut -f1`

# 单样本运行成功，且参数设置绝对路径。出现错误`Unrecognized option: -d64`参考**附录，质控Kneaddata，Java版本不匹配——重装Java运行环境**。
# 每步分析产生多个文件时新建子文件夹
# 每个线程处理百万序列约10分钟，多线程可加速 j x t 倍
# 注意此处引物文件必须填写绝对路径，否则无法使用
time parallel -j 2 --xapply \
  &quot;kneaddata -i seq/&#123;1&#125;_1.fq.gz \
  -i seq/&#123;1&#125;_2.fq.gz \
  -o temp/qc -v -t 3 --remove-intermediate-output \
  --trimmomatic /home/liuyongxin/miniconda2/envs/meta/share/trimmomatic/ \
  --trimmomatic-options &#39;ILLUMINACLIP:/home/liuyongxin/miniconda2/envs/meta/share/trimmomatic/adapters/TruSeq2-PE.fa:2:40:15 SLIDINGWINDOW:4:20 MINLEN:50&#39; \
  --reorder --bowtie2-options &#39;--very-sensitive --dovetail&#39; \
  -db $&#123;db&#125;/kneaddata/human_genome/Homo_sapiens&quot; \
  ::: `tail -n+2 result/metadata.txt|cut -f1`
</code></pre>
<h4 id="质控结果改名、临时文件删除和统计"><a href="#质控结果改名、临时文件删除和统计" class="headerlink" title="质控结果改名、临时文件删除和统计"></a>质控结果改名、临时文件删除和统计</h4><p>大文件清理，高宿主含量样本可节约&gt;90%空间</p>
<pre><code>rm -rf temp/qc/*contam* temp/qc/*unmatched*  temp/qc/*.fq
ls -l temp/qc/
</code></pre>
<p><strong>结果文件链接为新名</strong>：awk的system命令批处理系统命令，s为软链(快捷方式)、f为强制(force)</p>
<pre><code>awk &#39;&#123;system(&quot;ln -sf `pwd`/temp/qc/&quot;$1&quot;_1_kneaddata_paired_1.fastq temp/qc/&quot;$1&quot;_1.fastq&quot;)&#125;&#39; &lt;(tail -n+2 result/metadata.txt)
awk &#39;&#123;system(&quot;ln -sf `pwd`/temp/qc/&quot;$1&quot;_1_kneaddata_paired_2.fastq temp/qc/&quot;$1&quot;_2.fastq&quot;)&#125;&#39; &lt;(tail -n+2 result/metadata.txt)
ls -l temp/qc/
</code></pre>
<p>质控结果汇总</p>
<pre><code># 采用kneaddata附属工具kneaddata_read_count_table
kneaddata_read_count_table --input temp/qc \
  --output temp/kneaddata.txt
# 筛选重点结果列
cut -f 1,2,4,12,13 temp/kneaddata.txt | sed &#39;s/_1_kneaddata//&#39; &gt; result/qc/sum.txt
cat result/qc/sum.txt

# 用R代码统计下质控结果，可在本地运行
Rscript -e &quot;data=read.table(&#39;result/qc/sum.txt&#39;, header=T, row.names=1, sep=&#39;\t&#39;); summary(data)&quot;
# R转换宽表格为长表格
Rscript -e &quot;library(reshape2); data=read.table(&#39;result/qc/sum.txt&#39;, header=T,row.names=1, sep=&#39;\t&#39;); write.table(melt(data), file=&#39;result/qc/sum_long.txt&#39;,sep=&#39;\t&#39;, quote=F, col.names=T, row.names=F)&quot;
cat result/qc/sum_long.txt
# 可用 http://www.ehbio.com/ImageGP/ 绘图展示
</code></pre>
<h2 id="1-4-可选-质控后质量评估"><a href="#1-4-可选-质控后质量评估" class="headerlink" title="1.4 (可选)质控后质量评估"></a>1.4 (可选)质控后质量评估</h2><p>整理bowtie2, trimmomatic, fastqc报告，接头和PCR污染率一般小于1%。结果见：result/qc/multiqc_report_1.html</p>
<pre><code># 1-2m
fastqc temp/qc/*_1_kneaddata_paired_*.fastq -t 2
multiqc -d temp/qc/ -o result/qc/
# v1.7以后开始使用Python3，v1.8+缺少bowtie2比对结果的统计
</code></pre>
<h1 id="二、基于读长分析-Read-based-HUMAnN2"><a href="#二、基于读长分析-Read-based-HUMAnN2" class="headerlink" title="二、基于读长分析 Read-based (HUMAnN2)"></a>二、基于读长分析 Read-based (HUMAnN2)</h1><h2 id="2-1-准备HUMAnN2输入文件"><a href="#2-1-准备HUMAnN2输入文件" class="headerlink" title="2.1 准备HUMAnN2输入文件"></a>2.1 准备HUMAnN2输入文件</h2><p>小技巧：循环批量处理样本列表</p>
<pre><code># 基于样本元数据提取样本列表命令解析
# 去掉表头
tail -n+2 result/metadata.txt
# 提取第一列样本名
tail -n+2 result/metadata.txt|cut -f1
# 循环处理样本
for i in `tail -n+2 result/metadata.txt|cut -f1`;do echo &quot;Processing &quot;$i; done
# ` 反引号为键盘左上角Esc键下面的按键，一般在数字1的左边，代表运行命令返回结果
</code></pre>
<p>HUMAnN2要求双端序列合并的文件作为输入，for循环根据实验设计样本名批量双端序列合并。<br>注意星号和问号，分别代表多个和单个字符。当然大家更不能溜号~~~行分割的代码行末有一个 \ </p>
<pre><code>mkdir -p temp/concat
# 双端合并为单个文件
for i in `tail -n+2 result/metadata.txt|cut -f1`;do 
  cat temp/qc/$&#123;i&#125;_?.fastq \
  &gt; temp/concat/$&#123;i&#125;.fq; done
# 查看样品数量和大小
ls -shl temp/concat/*.fq
# 数据太大，计算时间长，可用head对单端分析截取20M序列，即3G，则为80M行，详见附录：HUMAnN2减少输出文件加速
</code></pre>
<h2 id="2-2-HUMAnN2计算物种和功能组成"><a href="#2-2-HUMAnN2计算物种和功能组成" class="headerlink" title="2.2 HUMAnN2计算物种和功能组成"></a>2.2 HUMAnN2计算物种和功能组成</h2><ul>
<li>物种组成调用MetaPhlAn2, bowtie2比对至核酸序列，解决有哪些微生物存在的问题；</li>
<li>功能组成为humann2调用diamond比对至蛋白库11Gb，解决这些微生物参与哪些功能通路的问题；</li>
<li>输入文件：temp/concat/*.fq 每个样品质控后双端合并后的fastq序列</li>
<li>输出文件：temp/humann2/ 目录下<ul>
<li>C1_pathabundance.tsv</li>
<li>C1_pathcoverage.tsv</li>
<li>C1_genefamilies.tsv</li>
</ul>
</li>
<li>整合后的输出：<ul>
<li>result/metaphlan2/taxonomy.tsv 物种丰度表</li>
<li>result/metaphlan2/taxonomy.spf 物种丰度表（用于stamp分析）</li>
<li>result/humann2/pathabundance_relab_unstratified.tsv 通路丰度表</li>
<li>result/humann2/pathabundance_relab_stratified.tsv 通路物种组成丰度表</li>
<li>stratified(每个菌对此功能通路组成的贡献)和unstratified(功能组成)</li>
</ul>
</li>
</ul>
<p>启动humann2环境：仅humann2布置于自定义环境下使用</p>
<pre><code># 方法1. conda加载环境
conda activate humann2
# 方法2. source加载指定
# source /home/liuyongxin/miniconda2/envs/humann2/bin/activate
</code></pre>
<p>检查数据库配置是否正确</p>
<pre><code>humann2 --version # v2.8.1
humann2_config
mkdir -p temp/humann2
</code></pre>
<p>单样本1.25M PE150运行测试，8p，2.5M，1~2h；0.2M, 34m；0.1M，30m；0.01M，25m；16p，18m</p>
<pre><code># CRITICAL ERROR: Can not call software version for bowtie2，见&quot;Perl环境&quot;
i=C1
# memusg -t humann2 --input temp/concat/$&#123;i&#125;.fq       --output temp/humann2 --threads 16
</code></pre>
<p>多样本并行计算，测试数据约30m，系统耗时12小时</p>
<pre><code>tail -n+2 result/metadata.txt|cut -f1|rush -j 2 \
  &#39;humann2 --input temp/concat/&#123;1&#125;.fq  \
  --output temp/humann2/&#39;

# (可选)大文件清理，humann2临时文件可达原始数据30~40倍
# 链接重要文件至humann2目录
for i in `tail -n+2 result/metadata.txt|cut -f1`;do 
   ln temp/humann2/$&#123;i&#125;_humann2_temp/$&#123;i&#125;_metaphlan_bugs_list.tsv temp/humann2/
done    
# 删除临时文件
rm -rf temp/concat/* temp/humann2/*_humann2_temp
</code></pre>
<h2 id="2-3-物种组成表"><a href="#2-3-物种组成表" class="headerlink" title="2.3 物种组成表"></a>2.3 物种组成表</h2><h3 id="2-3-1-样品结果合并"><a href="#2-3-1-样品结果合并" class="headerlink" title="2.3.1 样品结果合并"></a>2.3.1 样品结果合并</h3><pre><code>mkdir -p result/metaphlan2
# 合并、修正样本名、预览
merge_metaphlan_tables.py temp/humann2/*_metaphlan_bugs_list.tsv | \
  sed &#39;s/_metaphlan_bugs_list//g&#39; &gt; result/metaphlan2/taxonomy.tsv
head -n5 result/metaphlan2/taxonomy.tsv
</code></pre>
<h3 id="2-3-2-转换为stamp的spf格式"><a href="#2-3-2-转换为stamp的spf格式" class="headerlink" title="2.3.2 转换为stamp的spf格式"></a>2.3.2 转换为stamp的spf格式</h3><pre><code>metaphlan_to_stamp.pl result/metaphlan2/taxonomy.tsv \
  &gt; result/metaphlan2/taxonomy.spf
head -n5 result/metaphlan2/taxonomy.spf
# 下载metadata.txt和taxonomy.spf使用stamp分析
# 网络分析见附录 metaphlan2-共有或特有物种网络图
</code></pre>
<h3 id="2-3-3-可选-Python绘制热图"><a href="#2-3-3-可选-Python绘制热图" class="headerlink" title="2.3.3 (可选)Python绘制热图"></a>2.3.3 (可选)Python绘制热图</h3><pre><code># c设置颜色方案，top设置物种数量，minv最小相对丰度，s标准化方法，log为取10为底对数，xy为势图宽和高，图片可选pdf/png/svg格式
metaphlan_hclust_heatmap.py \
  --in result/metaphlan2/taxonomy.tsv \
  --out result/metaphlan2/heatmap.pdf \
  -c jet --top 30 --minv 0.1 \
  -s log -x 0.4 -y 0.2
# 报错解决详见附录：### metaphlan_hclust_heatmap.py报错AttributeError: Unknown property axisbg
# 帮助见 metaphlan_hclust_heatmap.py -h
# 更多绘制见3StatPlot.sh
</code></pre>
<h2 id="2-4-功能组成分析"><a href="#2-4-功能组成分析" class="headerlink" title="2.4 功能组成分析"></a>2.4 功能组成分析</h2><h3 id="2-4-1-功能组成合并、标准化和分层"><a href="#2-4-1-功能组成合并、标准化和分层" class="headerlink" title="2.4.1 功能组成合并、标准化和分层"></a>2.4.1 功能组成合并、标准化和分层</h3><p>合并通路丰度(pathabundance)，含功能和对应物种组成。<br>可选基因家族(genefamilies 太多)，通路覆盖度(pathcoverage)。<br>注意看屏幕输出<code># Gene table created: result/humann2/pathabundance.tsv</code></p>
<pre><code>mkdir -p result/humann2
humann2_join_tables \
  --input temp/humann2 \
  --file_name pathabundance \
  --output result/humann2/pathabundance.tsv
# 样本名调整：删除列名多余信息
head result/humann2/pathabundance.tsv
sed -i &#39;s/_Abundance//g&#39; result/humann2/pathabundance.tsv
# 预览和统计
head result/humann2/pathabundance.tsv
csvtk -t stat result/humann2/pathabundance.tsv
</code></pre>
<p>标准化为相对丰度relab(1)或百万比cpm(1,000,000)</p>
<pre><code>humann2_renorm_table \
  --input result/humann2/pathabundance.tsv \
  --units relab \
  --output result/humann2/pathabundance_relab.tsv
head -n5 result/humann2/pathabundance_relab.tsv
</code></pre>
<p>分层结果：功能和对应物种表(stratified)和功能组成表(unstratified)</p>
<pre><code>humann2_split_stratified_table \
  --input result/humann2/pathabundance_relab.tsv \
  --output result/humann2/ 
# 可以使用stamp进行统计分析
</code></pre>
<h3 id="2-4-2-差异比较和柱状图"><a href="#2-4-2-差异比较和柱状图" class="headerlink" title="2.4.2 差异比较和柱状图"></a>2.4.2 差异比较和柱状图</h3><p>两样本无法组间比较，在pcl层面替换为HMP数据进行统计和可视化。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://bitbucket.org/biobakery/humann2/wiki/Home#markdown-header-standard-workflow">https://bitbucket.org/biobakery/humann2/wiki/Home#markdown-header-standard-workflow</a></p>
<ul>
<li>输入数据：通路丰度表格 result/humann2/pathabundance.tsv</li>
<li>输入数据：实验设计信息 result/metadata.txt</li>
<li>中间数据：包含分组信息的通路丰度表格文件 result/humann2/pathabundance.pcl </li>
<li>输出结果：result/humann2/associate.txt</li>
</ul>
<p>在通路丰度中添加分组</p>
<pre><code>## 提取样品列表
head -n1 result/humann2/pathabundance.tsv | sed &#39;s/# Pathway/SampleID/&#39; | tr &#39;\t&#39; &#39;\n&#39; &gt; temp/header
## 对应分组，本示例分组为第2列($2)，根据实际情况修改
awk &#39;BEGIN&#123;FS=OFS=&quot;\t&quot;&#125;NR==FNR&#123;a[$1]=$2&#125;NR&gt;FNR&#123;print a[$1]&#125;&#39; result/metadata.txt temp/header | tr &#39;\n&#39; &#39;\t&#39;|sed &#39;s/\t$/\n/&#39; &gt; temp/group
# 合成样本、分组+数据
cat &lt;(head -n1 result/humann2/pathabundance.tsv) temp/group &lt;(tail -n+2 result/humann2/pathabundance.tsv) \
  &gt; result/humann2/pathabundance.pcl
head -n5 result/humann2/pathabundance.pcl
</code></pre>
<p>组间比较，样本量少无差异，结果为4列的文件：通路名字，通路在各个分组的丰度，差异P-value，校正后的Q-value。<br>演示数据2样本无法统计，此处替换为HMP的结果演示统计和绘图(上传hmp_pathabund.pcl，替换pathabundance.pcl为hmp_pathabund.pcl)。</p>
<pre><code>wget http://210.75.224.110/db/train/meta/result/humann2/hmp_pathabund.pcl
# cp /db/humann2/hmp_pathabund.pcl ./
mv hmp_pathabund.pcl result/humann2/
# 设置输入文件名
pcl=result/humann2/hmp_pathabund.pcl
# 统计表格行、列数量
csvtk -t stat $&#123;pcl&#125;
head -n2 $&#123;pcl&#125; |cut -f 1-5
# 按分组KW检验，注意第二列的分组列名
humann2_associate --input $&#123;pcl&#125; \
    --focal-metadatum Group --focal-type categorical \
    --last-metadatum Group --fdr 0.05 \
    --output result/humann2/associate.txt
wc -l result/humann2/associate.txt
head -n5 result/humann2/associate.txt
</code></pre>
<p>barplot展示通路的物种组成，如：腺苷核苷酸合成</p>
<pre><code># --sort sum metadata 按丰度和分组排序
# 指定差异通路，如 P163-PWY / PWY-3781 / PWY66-409 / PWY1F-823
path=PWY-3781
humann2_barplot --sort sum metadata \
    --input $&#123;pcl&#125; --focal-feature $&#123;path&#125; \
    --focal-metadatum Group --last-metadatum Group \
    --output result/humann2/barplot_$&#123;path&#125;.pdf
</code></pre>
<h3 id="2-4-3-转换为KEGG注释"><a href="#2-4-3-转换为KEGG注释" class="headerlink" title="2.4.3 转换为KEGG注释"></a>2.4.3 转换为KEGG注释</h3><p>需要下载utility_mapping数据库并配置成功才可以使用。详见软件和数据库安装1soft_db.sh。</p>
<p>支持GO、PFAM、eggNOG、level4ec、KEGG的D级KO等注释，详见<code>humann2_regroup_table -h</code>。</p>
<pre><code># 转换基因家族为KO(uniref90_ko)，可选eggNOG(uniref90_eggnog)或酶(uniref90_level4ec)
for i in `tail -n+2 result/metadata.txt|cut -f1`;do
  humann2_regroup_table \
    -i temp/humann2/$&#123;i&#125;_genefamilies.tsv \
    -g uniref90_ko \
    -o temp/humann2/$&#123;i&#125;_ko.tsv
done
# 合并，并修正样本名
humann2_join_tables \
  --input temp/humann2/ \
  --file_name ko \
  --output result/humann2/ko.tsv
sed -i &#39;1s/_Abundance-RPKs//g&#39; result/humann2/ko.tsv
tail result/humann2/ko.tsv
# 与pathabundance类似，可进行标准化renorm、分层stratified、柱状图barplot等操作
</code></pre>
<h2 id="2-5-GraPhlAn图"><a href="#2-5-GraPhlAn图" class="headerlink" title="2.5 GraPhlAn图"></a>2.5 GraPhlAn图</h2><pre><code># metaphlan2 to graphlan
export2graphlan.py --skip_rows 1,2 -i result/metaphlan2/taxonomy.tsv \
  --tree temp/merged_abundance.tree.txt \
  --annotation temp/merged_abundance.annot.txt \
  --most_abundant 1000 --abundance_threshold 20 --least_biomarkers 10 \
  --annotations 3,4 --external_annotations 7
# 参数说明见PPT，或运行 export2graphlan.py --help
# graphlan annotation
graphlan_annotate.py --annot temp/merged_abundance.annot.txt \
  temp/merged_abundance.tree.txt  temp/merged_abundance.xml
# output PDF figure, annoat and legend
graphlan.py temp/merged_abundance.xml result/metaphlan2/graphlan.pdf \
  --external_legends 
</code></pre>
<h2 id="2-6-LEfSe差异分析物种"><a href="#2-6-LEfSe差异分析物种" class="headerlink" title="2.6 LEfSe差异分析物种"></a>2.6 LEfSe差异分析物种</h2><ul>
<li>输入文件：物种丰度表result/metaphlan2/taxonomy.tsv</li>
<li>输入文件：样品分组信息 result/metadata.txt</li>
<li>中间文件：整合后用于LefSe分析的文件 result/metaphlan2/lefse.txt，这个文件可以提供给<a target="_blank" rel="noopener" href="http://www.ehbio.com/ImageGP">www.ehbio.com/ImageGP</a> 用于在线LefSE分析</li>
<li>LefSe结果输出：result/metaphlan2/目录下lefse开头和feature开头的文件</li>
</ul>
<p>前面演示数据仅有2个样本，无法进行差异比较。下面使用result12目录中由12个样本生成的结果表进行演示</p>
<pre><code># 设置结果目录，自己的数据使用result，演示用result12
result=result12
# 下载演示数据
# wget http://210.75.224.110/db/EasyMetagenome/result12.zip &amp;&amp; unzip result12.zip
</code></pre>
<p>准备输入文件，修改样本品为组名(可手动修改)</p>
<pre><code># 预览输出数据
head -n3 $result/metaphlan2/taxonomy.tsv
# 提取样本行，替换为每个样本一行，修改ID为SampleID
head -n1 $result/metaphlan2/taxonomy.tsv|tr &#39;\t&#39; &#39;\n&#39;|sed &#39;1 s/ID/SampleID/&#39; &gt;temp/sampleid
head -n3 temp/sampleid
# 提取SampleID对应的分组Group(假设为metadata.txt中第二列$2)，替换换行\n为制表符\t，再把行末制表符\t替换回换行
awk &#39;BEGIN&#123;OFS=FS=&quot;\t&quot;&#125;NR==FNR&#123;a[$1]=$2&#125;NR&gt;FNR&#123;print a[$1]&#125;&#39; $result/metadata.txt temp/sampleid|tr &#39;\n&#39; &#39;\t&#39;|sed &#39;s/\t$/\n/&#39; &gt;groupid
cat groupid
# 合并分组和数据(替换表头)
cat groupid &lt;(tail -n+2 $result/metaphlan2/taxonomy.tsv) &gt; $result/metaphlan2/lefse.txt
head -n3 $result/metaphlan2/lefse.txt
</code></pre>
<p>方法1. 推荐在线 <a target="_blank" rel="noopener" href="http://www.ehbio.com/ImageGP">http://www.ehbio.com/ImageGP</a> 中LEfSe一键分析 </p>
<p>方法2. (可选)LEfSe命令行分析代码供参考</p>
<pre><code># 格式转换为lefse内部格式
lefse-format_input.py \
  $result/metaphlan2/lefse.txt \
  temp/input.in -c 1 -o 1000000
# 运行lefse(样本无重复、分组将报错)
run_lefse.py temp/input.in \
  temp/input.res

# 绘制物种树注释差异
lefse-plot_cladogram.py temp/input.res \
  result/metaphlan2/lefse_cladogram.pdf --format pdf

# 绘制所有差异features柱状图
lefse-plot_res.py temp/input.res \
  $result/metaphlan2/lefse_res.pdf --format pdf
    
# 绘制单个features柱状图
# 查看显著差异features，按丰度排序
grep -v &#39;-&#39; temp/input.res | sort -k3,3n 
# 手动选择指定feature绘图，如Firmicutes
lefse-plot_features.py -f one \
  --feature_name &quot;k__Bacteria.p__Firmicutes&quot; \
  --format pdf \
  temp/input.in temp/input.res \
  $result/metaphlan2/lefse_Firmicutes.pdf

# 批量绘制所有差异features柱状图
lefse-plot_features.py -f diff \
  --archive none --format pdf \
  temp/input.in temp/input.res \
  $result/metaphlan2/lefse_
</code></pre>
<h2 id="2-7-Kraken2物种注释"><a href="#2-7-Kraken2物种注释" class="headerlink" title="2.7 Kraken2物种注释"></a>2.7 Kraken2物种注释</h2><p>Kraken2可以快速完成读长(read)层面的物种注释和定量，还可以进行重叠群(contig)、基因(gene)、宏基因组组装基因组(MAG/bin)层面的序列物种注释。</p>
<pre><code># 方法1.启动kraken2工作环境
conda activate kraken2
# 方法2.启动指定位置的环境
# source /conda2/envs/kraken2/bin/activate
# 记录软件版本
kraken2 --version # 2.1.1
</code></pre>
<h3 id="2-7-1-Kraken2物种注释"><a href="#2-7-1-Kraken2物种注释" class="headerlink" title="2.7.1 Kraken2物种注释"></a>2.7.1 Kraken2物种注释</h3><ul>
<li><p>{1}代表样本名字</p>
</li>
<li><p>输入：temp/qc/{1}_1_kneaddata_paired*.fastq 质控后的FASTQ数据</p>
</li>
<li><p>参考数据库：-db ${db}/kraken2/mini/，默认标准数据库&gt;50GB，这里使用8GB迷你数据库。</p>
</li>
<li><p>输出结果：每个样本单独输出，temp/kraken2/{1}_report和temp/kraken2/{1}_output</p>
</li>
<li><p>整合后的输出结果： result/kraken2/taxonomy_count.txt 物种丰度表</p>
<p>  mkdir -p temp/kraken2</p>
</li>
</ul>
<p>(可选) 单样本注释，5m</p>
<pre><code>i=C1
# 1m，--use-mpa-style可直接输出metphlan格式，但bracken无法处理
# 2020/12/02版，65K双端序列，38.58%可注释，61.42%未注释，耗时5s，内存峰值8G
# 2021/04/23版，65K双端序列，52.17%可注释，52.17%未注释，耗时5s，内存峰值8G
# 内存8G的PC可运行，需要与硬盘交换，需3m，内存峰值4.5G
kraken2 --db $&#123;db&#125;/kraken2/mini/ --paired temp/qc/$&#123;i&#125;_?.fastq \
  --threads 8 --use-names --report-zero-counts \
  --report temp/kraken2/$&#123;i&#125;.report \
  --output temp/kraken2/$&#123;i&#125;.output
</code></pre>
<p>多样本并行生成report，1样本8线程，内存大但速度快，内存不多不建议用多线程</p>
<pre><code>tail -n+2 result/metadata.txt|cut -f1|rush -j 2 \
  &quot;kraken2 --db $&#123;db&#125;/kraken2/mini --paired temp/qc/&#123;1&#125;_?.fastq \
  --threads 8 --use-names --report-zero-counts \
  --report temp/kraken2/&#123;1&#125;.report \
  --output temp/kraken2/&#123;1&#125;.output&quot;
</code></pre>
<p>使用krakentools转换report为mpa格式</p>
<pre><code>for i in `tail -n+2 result/metadata.txt|cut -f1`;do
  kreport2mpa.py -r temp/kraken2/$&#123;i&#125;.report \
    --display-header \
    -o temp/kraken2/$&#123;i&#125;.mpa;done
</code></pre>
<p>合并样本为表格</p>
<pre><code>mkdir -p result/kraken2
# 输出结果行数相同，但不一定顺序一致，要重新排序
tail -n+2 result/metadata.txt|cut -f1|rush -j 1 \
  &#39;tail -n+2 temp/kraken2/&#123;1&#125;.mpa | LC_ALL=C sort | cut -f 2 | sed &quot;1 s/^/&#123;1&#125;\n/&quot; &gt; temp/kraken2/&#123;1&#125;_count &#39;
# 提取第一样本品行名为表行名
header=`tail -n 1 result/metadata.txt | cut -f 1`
echo $header
tail -n+2 temp/kraken2/$&#123;header&#125;.mpa | LC_ALL=C sort | cut -f 1 | \
  sed &quot;1 s/^/Taxonomy\n/&quot; &gt; temp/kraken2/0header_count
head -n3 temp/kraken2/0header_count
# paste合并样本为表格
ls temp/kraken2/*count
paste temp/kraken2/*count &gt; result/kraken2/tax_count.mpa
# 检查表格及统计
csvtk -t stat result/kraken2/tax_count.mpa
</code></pre>
<h3 id="2-7-2-Bracken估计丰度"><a href="#2-7-2-Bracken估计丰度" class="headerlink" title="2.7.2 Bracken估计丰度"></a>2.7.2 Bracken估计丰度</h3><p>参数简介：</p>
<ul>
<li>-d为数据库，与kraken2一致</li>
<li>-i为输入kraken2报告文件</li>
<li>r是读长，此处为100，通常为150</li>
<li>l为分类级，本次种级别(S)丰度估计，可选域、门、纲、目、科、属、种：D,P,C,O,F,G,S</li>
<li>t是阈值，默认为0，越大越可靠，但可用数据越少</li>
<li>-o 输出重新估计的值</li>
</ul>
<p>循环重新估计每个样品的丰度</p>
<pre><code># 设置估算的分类级别D,P,C,O,F,G,S，常用 P和S
tax=P
mkdir -p temp/bracken
for i in `tail -n+2 result/metadata.txt|cut -f1`;do
    # i=C1
    bracken -d $&#123;db&#125;/kraken2/mini \
      -i temp/kraken2/$&#123;i&#125;.report \
      -r 100 -l $&#123;tax&#125; -t 0 \
      -o temp/bracken/$&#123;i&#125;;done
</code></pre>
<p>结果描述：共7列，分别为物种名、ID、分类级、读长计数、补充读长计数、<strong>总数、百分比</strong></p>
<pre><code>name    taxonomy_id     taxonomy_lvl    kraken_assigned_reads   added_reads     new_est_reads        fraction_total_reads
Capnocytophaga sputigena        1019    S       4798    996     5794    0.23041
Capnocytophaga sp. oral taxon 878       1316596 S       239     21      260     0.01034
</code></pre>
<p>bracken结果合并成表</p>
<pre><code># 输出结果行数相同，但不一定顺序一致，要去年表头重新排序
# 仅提取第6列reads count，并添加样本名
tail -n+2 result/metadata.txt|cut -f1|rush -j 1 \
  &#39;tail -n+2 temp/bracken/&#123;1&#125; | LC_ALL=C sort | cut -f6 | sed &quot;1 s/^/&#123;1&#125;\n/&quot; &gt; temp/bracken/&#123;1&#125;.count &#39;
# 提取第一样本品行名为表行名
h=`tail -n1 result/metadata.txt|cut -f1`
tail -n+2 temp/bracken/$&#123;h&#125;|sort|cut -f1 | \
  sed &quot;1 s/^/Taxonomy\n/&quot; &gt; temp/bracken/0header.count
# 检查文件数，为n+1
ls temp/bracken/*count | wc
# paste合并样本为表格，并删除非零行
paste temp/bracken/*count &gt; result/kraken2/bracken.$&#123;tax&#125;.txt
# 统计行列，默认去除表头
csvtk -t stat result/kraken2/bracken.$&#123;tax&#125;.txt
</code></pre>
<p>结果筛选</p>
<pre><code># 需要指定安装R的位置和脚本位置
# alias Rscript=&quot;/anaconda2/bin/Rscript --vanilla&quot;
sd=/db/EasyMicrobiome/script

# microbiome_helper按频率过滤，-r可标准化，-e过滤
Rscript $sd/filter_feature_table.R \
  -i result/kraken2/bracken.$&#123;tax&#125;.txt \
  -p 0.01 \
  -o result/kraken2/bracken.$&#123;tax&#125;.0.01
# &gt; 0.01(1%)的样本在出现，数量会明显减少
csvtk -t stat result/kraken2/bracken.$&#123;tax&#125;.0.01

# 门水平去除脊索动物
grep &#39;Chordata&#39; result/kraken2/bracken.P.0.01
grep -v &#39;Chordata&#39; result/kraken2/bracken.P.0.01 &gt; result/kraken2/bracken.P.0.01-H

# 按物种名手动去除宿主污染，以人为例(需按种水平计算相关结果)
# 种水平去除人类P:Chordata,S:Homo sapiens
grep &#39;Homo sapiens&#39; result/kraken2/bracken.S.0.01
grep -v &#39;Homo sapiens&#39; result/kraken2/bracken.S.0.01 &gt; result/kraken2/bracken.S.0.01-H
</code></pre>
<p>分析后清理每条序列的注释大文件</p>
<pre><code># rm -rf temp/kraken2/*.output
</code></pre>
<p>多样性分析/物种组成，详见3StatPlot.sh，Kraken2结果筛选序列见附录</p>
<h1 id="三、组装分析流程-Assemble-based"><a href="#三、组装分析流程-Assemble-based" class="headerlink" title="三、组装分析流程 Assemble-based"></a>三、组装分析流程 Assemble-based</h1><h2 id="3-1-拼接-Assembly"><a href="#3-1-拼接-Assembly" class="headerlink" title="3.1 拼接 Assembly"></a>3.1 拼接 Assembly</h2><h3 id="3-1-1-MEGAHIT拼接"><a href="#3-1-1-MEGAHIT拼接" class="headerlink" title="3.1.1 MEGAHIT拼接"></a>3.1.1 MEGAHIT拼接</h3><pre><code># 启动工作环境
conda activate meta

# 删除旧文件夹，否则megahit无法运行
rm -rf temp/megahit
# 组装，10~30m，TB级数据需几天至几周
megahit -t 6 \
    -1 `tail -n+2 result/metadata.txt|cut -f1|sed &#39;s/^/temp\/qc\//;s/$/_1.fastq/&#39;|tr &#39;\n&#39; &#39;,&#39;|sed &#39;s/,$//&#39;` \
    -2 `tail -n+2 result/metadata.txt|cut -f1|sed &#39;s/^/temp\/qc\//;s/$/_2.fastq/&#39;|tr &#39;\n&#39; &#39;,&#39;|sed &#39;s/,$//&#39;` \
    -o temp/megahit 
# 统计大小通常300M~5G，如果contigs太多，可以按长度筛选，降低数据量，提高基因完整度，详见附录megahit
seqkit stat temp/megahit/final.contigs.fa
# 预览重叠群最前6行，前60列字符
head -n6 temp/megahit/final.contigs.fa | cut -c1-60

# 备份重要结果
mkdir -p result/megahit/
ln -f temp/megahit/final.contigs.fa result/megahit/
# 删除临时文件
rm -rf temp/megahit/intermediate_contigs/
</code></pre>
<h3 id="3-1-2-可选-metaSPAdes精细拼接"><a href="#3-1-2-可选-metaSPAdes精细拼接" class="headerlink" title="3.1.2 (可选) metaSPAdes精细拼接"></a>3.1.2 (可选) metaSPAdes精细拼接</h3><pre><code># 精细但使用内存和时间更多，15~65m
memusg -t metaspades.py -t 3 -m 100 \
  `tail -n+2 result/metadata.txt|cut -f1|sed &#39;s/^/temp\/qc\//;s/$/_1.fastq/&#39;|sed &#39;s/^/-1 /&#39;| tr &#39;\n&#39; &#39; &#39;` \
  `tail -n+2 result/metadata.txt|cut -f1|sed &#39;s/^/temp\/qc\//;s/$/_2.fastq/&#39;|sed &#39;s/^/-2 /&#39;| tr &#39;\n&#39; &#39; &#39;` \
  -o temp/metaspades
# 23M，contigs体积更大
seqkit stat temp/metaspades/contigs.fasta

# 备份重要结果
mkdir -p result/metaspades/
ln -f temp/metaspades/contigs.fasta result/metaspades/
# 删除临时文件
rm -rf temp/metaspades
</code></pre>
<p>注：metaSPAdes支持二、三代混合组装，见附录，此外还有OPERA-MS组装二、三代方案</p>
<h3 id="3-1-3-QUAST评估"><a href="#3-1-3-QUAST评估" class="headerlink" title="3.1.3 QUAST评估"></a>3.1.3 QUAST评估</h3><pre><code>quast.py result/megahit/final.contigs.fa -o result/megahit/quast -t 2
# 生成report文本tsv/txt、网页html、PDF等格式报告

# (可选) megahit和metaspades比较
quast.py --label &quot;megahit,metapasdes&quot; \
    result/megahit/final.contigs.fa \
    result/metaspades/contigs.fasta \
    -o result/quast

# (可选)metaquast评估，更全面，但需下载相关数据库，受网速影响可能时间很长(我很少成功)
# metaquast based on silva, and top 50 species genome to access
time metaquast.py result/megahit/final.contigs.fa -o result/megahit/metaquast
</code></pre>
<h2 id="3-2-基因预测、去冗余和定量"><a href="#3-2-基因预测、去冗余和定量" class="headerlink" title="3.2 基因预测、去冗余和定量"></a>3.2 基因预测、去冗余和定量</h2><pre><code># Gene prediction, cluster &amp; quantitfy
</code></pre>
<h3 id="3-2-1-metaProdigal基因预测"><a href="#3-2-1-metaProdigal基因预测" class="headerlink" title="3.2.1 metaProdigal基因预测"></a>3.2.1 metaProdigal基因预测</h3><pre><code># 输入文件：拼装好的序列文件 result/megahit/final.contigs.fa
# 输出文件：prodigal预测的基因序列 temp/prodigal/gene.fa
# 基因文件大，可参考附录prodigal拆分基因文件，并行计算

mkdir -p temp/prodigal
# prodigal的meta模式预测基因，35s，&gt;和2&gt;&amp;1记录分析过程至gene.log
prodigal -i result/megahit/final.contigs.fa \
    -d temp/prodigal/gene.fa \
    -o temp/prodigal/gene.gff \
    -p meta -f gff &gt; temp/prodigal/gene.log 2&gt;&amp;1 
# 查看日志是否运行完成，有无错误
tail temp/prodigal/gene.log
# 统计基因数量
seqkit stat temp/prodigal/gene.fa 
# 统计完整基因数量，数据量大可只用完整基因部分
grep -c &#39;partial=00&#39; temp/prodigal/gene.fa 
# 提取完整基因(完整片段获得的基因全为完整，如成环的细菌基因组)
grep &#39;partial=00&#39; temp/prodigal/gene.fa | cut -f1 -d &#39; &#39;| sed &#39;s/&gt;//&#39; &gt; temp/prodigal/full_length.id
seqkit grep -f temp/prodigal/full_length.id temp/prodigal/gene.fa &gt; temp/prodigal/full_length.fa
seqkit stat temp/prodigal/full_length.fa
</code></pre>
<h3 id="3-2-2-基因聚类-去冗余cd-hit"><a href="#3-2-2-基因聚类-去冗余cd-hit" class="headerlink" title="3.2.2 基因聚类/去冗余cd-hit"></a>3.2.2 基因聚类/去冗余cd-hit</h3><pre><code># 输入文件：prodigal预测的基因序列 temp/prodigal/gene.fa
# 输出文件：去冗余后的基因和蛋白序列：result/NR/nucleotide.fa, result/NR/protein.fa

mkdir -p result/NR
# aS覆盖度，c相似度，G局部比对，g最优解，T多线程，M内存0不限制
# 2万基因2m，2千万需要2000h，多线程可加速
cd-hit-est -i temp/prodigal/gene.fa \
    -o result/NR/nucleotide.fa \
    -aS 0.9 -c 0.95 -G 0 -g 0 -T 0 -M 0
# 统计非冗余基因数量，单次拼接结果数量下降不大，多批拼接冗余度高
grep -c &#39;&gt;&#39; result/NR/nucleotide.fa
# 翻译核酸为对应蛋白序列, --trim去除结尾的*
seqkit translate --trim result/NR/nucleotide.fa \
    &gt; result/NR/protein.fa 
# 两批数据去冗余使用cd-hit-est-2d加速，见附录
</code></pre>
<h3 id="3-2-3-基因定量salmon"><a href="#3-2-3-基因定量salmon" class="headerlink" title="3.2.3 基因定量salmon"></a>3.2.3 基因定量salmon</h3><pre><code># 输入文件：去冗余后的基因和蛋白序列：result/NR/nucleotide.fa
# 输出文件：Salmon定量后的结果：result/salmon/gene.count, gene.TPM

mkdir -p temp/salmon
salmon -v # 1.4.0

# 建索引, -t序列, -i 索引，10s
salmon index \
  -t result/NR/nucleotide.fa \
  -p 9 \
  -i temp/salmon/index 

# 定量，l文库类型自动选择，p线程，--meta宏基因组模式, 2个任务并行2个样
# 注意parallel中待并行的命令必须是双引号，内部变量需要使用原始绝对路径 
tail -n+2 result/metadata.txt|cut -f1|rush -j 2 \
  &quot;salmon quant \
    -i temp/salmon/index -l A -p 3 --meta \
    -1 temp/qc/&#123;1&#125;_1.fastq \
    -2 temp/qc/&#123;1&#125;_2.fastq \
    -o temp/salmon/&#123;1&#125;.quant&quot;

# 合并
mkdir -p result/salmon
salmon quantmerge --quants temp/salmon/*.quant \
    -o result/salmon/gene.TPM
salmon quantmerge --quants temp/salmon/*.quant \
    --column NumReads -o result/salmon/gene.count
sed -i &#39;1 s/.quant//g&#39; result/salmon/gene.*

# 预览结果表格
head -n3 result/salmon/gene.*
</code></pre>
<h2 id="3-3-功能基因注释"><a href="#3-3-功能基因注释" class="headerlink" title="3.3 功能基因注释"></a>3.3 功能基因注释</h2><pre><code># 输入数据：上一步预测的蛋白序列 result/NR/protein.fa
# 中间结果：temp/eggnog/protein.emapper.seed_orthologs
#           temp/eggnog/output.emapper.annotations
#           temp/eggnog/output

# COG定量表：result/eggnog/cogtab.count
#            result/eggnog/cogtab.count.spf (用于STAMP)

# KO定量表：result/eggnog/kotab.count
#           result/eggnog/kotab.count.spf  (用于STAMP)

# CAZy碳水化合物注释和定量：result/dbcan2/cazytab.count
#                           result/dbcan2/cazytab.count.spf (用于STAMP)

# 抗生素抗性：result/resfam/resfam.count
#             result/resfam/resfam.count.spf (用于STAMP)

# 这部分可以拓展到其它数据库
</code></pre>
<h3 id="3-3-1-基因注释eggNOG-COG-KEGG-CAZy"><a href="#3-3-1-基因注释eggNOG-COG-KEGG-CAZy" class="headerlink" title="3.3.1 基因注释eggNOG(COG/KEGG/CAZy)"></a>3.3.1 基因注释eggNOG(COG/KEGG/CAZy)</h3><pre><code># https://github.com/eggnogdb/eggnog-mapper/wiki/eggNOG-mapper-v2

# 记录软件版本
conda activate eggnog
emapper.py --version # 2.1.6

# diamond比对基因至eggNOG 5.0数据库, 9p11m, 1~9h，默认diamond 1e-3
mkdir -p temp/eggnog
time emapper.py --no_annot --no_file_comments --override \
  --data_dir $&#123;db&#125;/eggnog \
  -i result/NR/protein.fa \
  --cpu 9 -m diamond \
  -o temp/eggnog/protein

# 比对结果功能注释, 1h # sqlite3.OperationalError: no such table: prots是数据库不配套，重新下载即可
emapper.py \
  --annotate_hits_table temp/eggnog/protein.emapper.seed_orthologs \
  --data_dir $&#123;db&#125;/eggnog \
  --cpu 9 --no_file_comments --override \
  -o temp/eggnog/output

# 2.1较2.0结果又有新变化，添加了#号表头，减少了列
sed &#39;1 s/^#//&#39; temp/eggnog/output.emapper.annotations \
  &gt; temp/eggnog/output
csvtk -t headers -v temp/eggnog/output
</code></pre>
<p>summarizeAbundance生成COG/KO/CAZy丰度汇总表</p>
<pre><code>mkdir -p result/eggnog
# 显示帮助，需要Python3环境，可修改软件第一行指定python位置，如指定某Python执行脚本 /mnt/bai/yongxin/miniconda2/envs/humann3/bin/python3 /db/EasyMicrobiome/script/summarizeAbundance.py
summarizeAbundance.py -h
# 汇总，7列COG_category按字母分隔，12列KEGG_ko和19列CAZy按逗号分隔，原始值累加
# 指定humann3中的Python 3.7.6运行正常，qiime2中的Python 3.6.13报错
summarizeAbundance.py \
  -i result/salmon/gene.TPM \
  -m temp/eggnog/output \
  -c &#39;7,12,19&#39; -s &#39;*+,+,&#39; -n raw \
  -o result/eggnog/eggnog
sed -i &#39;s/^ko://&#39; result/eggnog/eggnog.KEGG_ko.raw.txt
sed -i &#39;/^-/d&#39; result/eggnog/eggnog*
# eggnog.CAZy.raw.txt  eggnog.COG_category.raw.txt  eggnog.KEGG_ko.raw.txt

# 添加注释生成STAMP的spf格式，结合metadata.txt进行差异比较
awk &#39;BEGIN&#123;FS=OFS=&quot;\t&quot;&#125; NR==FNR&#123;a[$1]=$2&#125; NR&gt;FNR&#123;print a[$1],$0&#125;&#39; \
  /db/EasyMicrobiome/kegg/KO_description.txt \
  result/eggnog/eggnog.KEGG_ko.raw.txt | \
  sed &#39;s/^\t/Unannotated\t/&#39; \
  &gt; result/eggnog/eggnog.KEGG_ko.TPM.spf
# KO to level 1/2/3
summarizeAbundance.py \
  -i result/eggnog/eggnog.KEGG_ko.raw.txt \
  -m /db/EasyMicrobiome/kegg/KO1-4.txt \
  -c 2,3,4 -s &#39;,+,+,&#39; -n raw \
  -o result/eggnog/KEGG
 
# CAZy
awk &#39;BEGIN&#123;FS=OFS=&quot;\t&quot;&#125; NR==FNR&#123;a[$1]=$2&#125; NR&gt;FNR&#123;print a[$1],$0&#125;&#39; \
   /db/EasyMicrobiome/dbcan2/CAZy_description.txt result/eggnog/eggnog.CAZy.raw.txt | \
  sed &#39;s/^\t/Unannotated\t/&#39; &gt; result/eggnog/eggnog.CAZy.TPM.spf

# COG
awk &#39;BEGIN&#123;FS=OFS=&quot;\t&quot;&#125; NR==FNR&#123;a[$1]=$2&quot;\t&quot;$3&#125; NR&gt;FNR&#123;print a[$1],$0&#125;&#39; \
  /db/EasyMicrobiome/eggnog/COG.anno result/eggnog/eggnog.COG_category.raw.txt &gt; \
  result/eggnog/eggnog.COG_category.TPM.spf
</code></pre>
<h3 id="3-3-2-可选-碳水化合物dbCAN2"><a href="#3-3-2-可选-碳水化合物dbCAN2" class="headerlink" title="3.3.2 (可选)碳水化合物dbCAN2"></a>3.3.2 (可选)碳水化合物dbCAN2</h3><pre><code># 比对CAZy数据库, 用时2~18m
mkdir -p temp/dbcan2
# --sensitive慢10倍，dbCAN2推荐e值为1e-102，此处结果3条太少，以1e-3为例演示
diamond blastp \
  --db /db/dbcan2/CAZyDB.09242021 \
  --query result/NR/protein.fa \
  --threads 9 -e 1e-3 --outfmt 6 --max-target-seqs 1 --quiet \
  --out temp/dbcan2/gene_diamond.f6
wc -l temp/dbcan2/gene_diamond.f6
# 整理比对数据为表格 
mkdir -p result/dbcan2
# 提取基因与dbcan分类对应表
format_dbcan2list.pl \
  -i temp/dbcan2/gene_diamond.f6 \
  -o temp/dbcan2/gene.list 
# 按对应表累计丰度，依赖
summarizeAbundance.py \
  -i result/salmon/gene.TPM \
  -m temp/dbcan2/gene.list \
  -c 2 -s &#39;,&#39; -n raw \
  -o result/dbcan2/TPM
# 添加注释生成STAMP的spf格式，结合metadata.txt进行差异比较
awk &#39;BEGIN&#123;FS=OFS=&quot;\t&quot;&#125; NR==FNR&#123;a[$1]=$2&#125; NR&gt;FNR&#123;print a[$1],$0&#125;&#39; \
   /db/EasyMicrobiome/dbcan2/CAZy_description.txt result/dbcan2/TPM.CAZy.raw.txt | \
  sed &#39;s/^\t/Unannotated\t/&#39; &gt; result/dbcan2/TPM.CAZy.raw.spf
# 检查未注释数量，有则需要检查原因
# grep &#39;Unannotated&#39; result/dbcan2/TPM.CAZy.raw.spf|wc -l
</code></pre>
<h3 id="3-3-3-抗生素抗性CARD"><a href="#3-3-3-抗生素抗性CARD" class="headerlink" title="3.3.3 抗生素抗性CARD"></a>3.3.3 抗生素抗性CARD</h3><p>数据库：<a target="_blank" rel="noopener" href="https://card.mcmaster.ca/">https://card.mcmaster.ca/</a> ，有在线分析平台，本地代码供参考</p>
<pre><code># 参考文献：http://doi.org/10.1093/nar/gkz935
# 软件使用Github: https://github.com/arpcard/rgi
# 启动rgi环境
conda activate rgi
rgi -h # 5.2.1
# 蛋白注释
mkdir -p result/card
cut -f 1 -d &#39; &#39; result/NR/protein.fa &gt; temp/protein.fa
rgi main -i temp/protein.fa -t protein \
  -n 9 -a DIAMOND --include_loose --clean \
  -o result/card/protein
</code></pre>
<p>结果说明：</p>
<ul>
<li>protein.json，在线可视化</li>
<li>protein.txt，注释基因列表</li>
</ul>
<h2 id="3-4-基因物种注释"><a href="#3-4-基因物种注释" class="headerlink" title="3.4 基因物种注释"></a>3.4 基因物种注释</h2><pre><code># Generate report in default taxid output
conda activate meta
memusg -t kraken2 --db /db/kraken2/mini \
  result/NR/nucleotide.fa \
  --threads 3 \
  --report temp/NRgene.report \
  --output temp/NRgene.output
# Genes &amp; taxid list
grep &#39;^C&#39; temp/NRgene.output|cut -f 2,3|sed &#39;1 i Name\ttaxid&#39; \
  &gt; temp/NRgene.taxid
# Add taxonomy
awk &#39;BEGIN&#123;FS=OFS=&quot;\t&quot;&#125; NR==FNR&#123;a[$1]=$0&#125; NR&gt;FNR&#123;print $1,a[$2]&#125;&#39; \
  /db/EasyMicrobiome/kraken2/taxonomy.txt \
  temp/NRgene.taxid \
  &gt; result/NR/nucleotide.tax
memusg -t /conda2/envs/humann3/bin/python3 /db/EasyMicrobiome/script/summarizeAbundance.py \
  -i result/salmon/gene.TPM \
  -m result/NR/nucleotide.tax \
  -c &#39;2,3,4,5,6,7,8,9&#39; -s &#39;,+,+,+,+,+,+,+,&#39; -n raw \
  -o result/NR/tax
wc -l result/NR/tax*|sort -n
</code></pre>
<h1 id="四、挖掘单菌基因组-分箱-Binning"><a href="#四、挖掘单菌基因组-分箱-Binning" class="headerlink" title="四、挖掘单菌基因组/分箱(Binning)"></a>四、挖掘单菌基因组/分箱(Binning)</h1><h2 id="4-1-MetaWRAP"><a href="#4-1-MetaWRAP" class="headerlink" title="4.1 MetaWRAP"></a>4.1 MetaWRAP</h2><pre><code># 主要使用MetaWRAP，演示基于官方测试数据
# 主页：https://github.com/bxlab/metaWRAP
# 挖掘单菌基因组，需要研究对象复杂度越低、测序深度越大，结果质量越好。要求单样本6GB+，复杂样本如土壤推荐数据量30GB+，至少3个样本
# 上面的演示数据12个样仅140MB，无法获得单菌基因组，这里使用官方测序数据演示讲解
# 软件和数据库布置需2-3天，演示数据分析过程超10h，标准30G样也需3-30天，由服务器性能决定。
</code></pre>
<h3 id="4-1-1-准备数据和环境变量"><a href="#4-1-1-准备数据和环境变量" class="headerlink" title="4.1.1 准备数据和环境变量"></a>4.1.1 准备数据和环境变量</h3><pre><code># 流程: https://github.com/bxlab/metaWRAP/blob/master/Usage_tutorial.md
&gt; 
# 输入数据：质控后的FASTQ序列，文件名格式必须为*_1.fastq和*_2.fastq
#           C1_1_kneaddata_paired_1.fastq  -&gt; C1_1_1.fq
#           C1_1_kneaddata_paired_2.fastq  -&gt; C1_1_2.fq
#           放置到 binning/temp/qc 目录下

# 拼装获得的contig文件：result/megahit/final.contigs.fa
#           放置到 binning/temp/megahit 目录下
#        

# 中间输出文件：
#     Binning结果：binning/temp/binning
#     提纯后的Bin统计结果：binning/temp/bin_refinement/metawrap_50_10_bins.stats
#     Bin定量结果文件：binning/temp/bin_quant/bin_abundance_heatmap.png
#                      binning/temp/bin_quant/bin_abundance_table.tab (数据表)
#     Bin物种注释结果：binning/temp/bin_classify/bin_taxonomy.tab
#     Prokka基因预测结果：binning/temp/bin_annotate/prokka_out/bin.10.ffn 核酸序列
#     Bin可视化结果：binning/temp/bloblogy/final.contigs.binned.blobplot (数据表)
#                    binning/temp/bloblogy/blobplot_figures (可视化图)

# 准备原始数据从头分析，详见公众号或官网教程
# 这里我们从质控后数据和拼接结果开始
cd $&#123;wd&#125;
mkdir -p binning &amp;&amp; cd binning
mkdir -p temp &amp;&amp; cd temp
# 这里基于质控clean数据和拼接好的contigs，自己链接自上游分析
# 7G质控数据，输入数据文件名格式必须为*_1.fastq和*_2.fastq
mkdir -p seq
cd seq
# 方法1. 下载测序数据
# for i in `seq 7 9`;do
#    wget -c http://210.75.224.110/share/meta/metawrap/ERR01134$&#123;i&#125;_1.fastq.gz
#    wget -c http://210.75.224.110/share/meta/metawrap/ERR01134$&#123;i&#125;_2.fastq.gz
# done
# gunzip *.gz # 解压文件
# rename .fq .fastq *.fq # 批量修改扩展名
# 方法2. 复制准备好的数据
ln -sf $&#123;db&#125;/metawrap/*.fastq ./
cd ..
# megahit拼接结果
mkdir -p megahit
cd megahit
# wget -c http://210.75.224.110/share/meta/metawrap/final.contigs.fa.gz
# gunzip *.gz
ln -s $&#123;db&#125;/metawrap/*.fa ./
cd ../..

# 加载运行环境
cd $&#123;wd&#125;/binning
conda activate metawrap
</code></pre>
<h3 id="4-1-2-运行三种分箱软件"><a href="#4-1-2-运行三种分箱软件" class="headerlink" title="4.1.2 运行三种分箱软件"></a>4.1.2 运行三种分箱软件</h3><pre><code>metawrap -v
# 输入文件为contig和clean reads
# 调用三大主流binning程序cococt, maxbin2, metabat2
# 8p线程2h，24p耗时1h
# nohup 和 &amp; 保证任务在后台不被中断，且记录输出内容到 nohup.out(可选)
nohup metawrap binning -o temp/binning -t 1 -a temp/megahit/final.contigs.fa \
  --metabat2 --maxbin2 --concoct temp/seq/ERR*.fastq &amp;
# 用自己的文件，替换输出文件名为 *1_kneaddata_paired*.fastq 
# 如果想接上上面的流程使用自己的文件做分析，则把ERR*.fastq替换为 *1_kneaddata_paired*.fastq
# 输出文件夹 temp/binning 包括3种软件结果和中间文件
</code></pre>
<h3 id="4-1-3-Bin提纯"><a href="#4-1-3-Bin提纯" class="headerlink" title="4.1.3 Bin提纯"></a>4.1.3 Bin提纯</h3><pre><code># 8线程2h， 24p 1h
cd $&#123;wd&#125;/binning
# rm -rf temp/bin_refinement
metawrap bin_refinement \
  -o temp/bin_refinement \
  -A temp/binning/metabat2_bins/ \
  -B temp/binning/maxbin2_bins/ \
  -C temp/binning/concoct_bins/ \
  -c 50 -x 10 -t 2
# 查看高质量Bin的数量，10个，见temp/bin_refinement/metawrap_50_10_bins.stats目录
wc -l temp/bin_refinement/metawrap_50_10_bins.stats
# 结果改进程度见temp/bin_refinement/figures/目录
</code></pre>
<h3 id="4-1-4-Bin定量"><a href="#4-1-4-Bin定量" class="headerlink" title="4.1.4 Bin定量"></a>4.1.4 Bin定量</h3><pre><code># 使用salmon计算每个bin在样本中相对丰度
# 耗时3m，系统用时10m，此处可设置线程，但salmon仍调用全部资源

# 需要指定输出文件夹，包括4.3中的参数的输出目录
metawrap quant_bins -b temp/bin_refinement/metawrap_50_10_bins -t 8 \
  -o temp/bin_quant -a temp/megahit/final.contigs.fa temp/seq/ERR*.fastq
# 文件名字改变
# 结果包括bin丰度热图`temp/bin_quant/bin_abundance_heatmap.png`
# 如果想自己画图，原始数据位于`temp/bin_quant/bin_abundance_table.tab`
ls -l temp/bin_quant/bin_abundance_heatmap.png
</code></pre>
<h3 id="4-1-5-Bin注释"><a href="#4-1-5-Bin注释" class="headerlink" title="4.1.5 Bin注释"></a>4.1.5 Bin注释</h3><pre><code># Taxator-tk对每条contig物种注释，再估计bin整体的物种，11m (用时66 min)
metawrap classify_bins -b temp/bin_refinement/metawrap_50_10_bins \
  -o temp/bin_classify -t 2 &amp;
# 注释结果见`temp/bin_classify/bin_taxonomy.tab`

# export LD_LIBRARY_PATH=/conda2/envs/metagenome_env/lib/:$&#123;LD_LIBRARY_PATH&#125;
 # 这是动态链接库找不到时的一个简单的应急策略
ln -s /conda2/envs/metagenome_env/lib/libssl.so.1.0.0 .
ln -s /conda2/envs/metagenome_env/lib/libcrypto.so.1.0.0 .

# 基于prokka基因注释，4m
metaWRAP annotate_bins -o temp/bin_annotate \
  -b temp/bin_refinement/metawrap_50_10_bins  -t 1
# 每个bin基因注释的gff文件bin_funct_annotations, 
# 核酸ffn文件bin_untranslated_genes，
# 蛋白faa文件bin_translated_genes
</code></pre>
<h2 id="可选-MetaWRAP单样本分别组装和分箱"><a href="#可选-MetaWRAP单样本分别组装和分箱" class="headerlink" title="(可选)MetaWRAP单样本分别组装和分箱"></a>(可选)MetaWRAP单样本分别组装和分箱</h2><p>多样本受硬件、计算时间限制无法完成时，需要单样本组装、分析。或想进一步提高组装质量，减少污染和杂合度，也可以单样本组装。</p>
<h3 id="参数设定"><a href="#参数设定" class="headerlink" title="参数设定"></a>参数设定</h3><pre><code># 样本名
i=ERR011347
# 线程数
p=1
# 任务数
j=2
# 定义完整度和污染率的阈值(50, 5; Finn NBT 2020; 50, 10, Bowers NBT 2017)
c=50
x=10
</code></pre>
<p>输和文件在seq目录</p>
<pre><code>mkdir -p seq
ln -s `pwd`/temp/seq/*.fastq seq/
</code></pre>
<h3 id="1-megahit组装"><a href="#1-megahit组装" class="headerlink" title="1 megahit组装"></a>1 megahit组装</h3><p>单样本并行组装，13m，314m</p>
<pre><code>rm -rf temp/megahit_*
time parallel -j $&#123;j&#125; \
&quot;metawrap assembly \
    -1 seq/&#123;&#125;_1.fastq \
    -2 seq/&#123;&#125;_2.fastq \
    -o temp/megahit_&#123;&#125; \
    -m 100 -t $&#123;p&#125; --megahit&quot; \
 ::: `ls seq/|cut -f1 -d &#39;_&#39;|uniq`  
</code></pre>
<h3 id="2-运行三种bin软件"><a href="#2-运行三种bin软件" class="headerlink" title="2 运行三种bin软件"></a>2 运行三种bin软件</h3><pre><code># 192p, 15m (concoct会使用所有线程)
parallel -j $&#123;j&#125; \
&quot;metawrap binning \
    -o temp/binning_&#123;&#125; -t $&#123;p&#125; \
    -a temp/megahit_&#123;&#125;/final_assembly.fasta \
    --metabat2 --maxbin2 --concoct \
    seq/&#123;&#125;_*.fastq&quot; \
::: `ls seq/|cut -f1 -d &#39;_&#39;|uniq`
</code></pre>
<h3 id="3-Bin提纯"><a href="#3-Bin提纯" class="headerlink" title="3 Bin提纯"></a>3 Bin提纯</h3><pre><code># 24p，10h
parallel -j $&#123;j&#125; \
&quot;metawrap bin_refinement \
  -o temp/bin_refinement_&#123;&#125; -t $&#123;p&#125; \
  -A temp/binning_&#123;&#125;/metabat2_bins/ \
  -B temp/binning_&#123;&#125;/maxbin2_bins/ \
  -C temp/binning_&#123;&#125;/concoct_bins/ \
  -c $&#123;c&#125; -x $&#123;x&#125;&quot; \
::: `ls seq/|cut -f1 -d &#39;_&#39;|uniq`
</code></pre>
<h2 id="4-2-dRep去冗余种-株基因组集"><a href="#4-2-dRep去冗余种-株基因组集" class="headerlink" title="4.2 dRep去冗余种/株基因组集"></a>4.2 dRep去冗余种/株基因组集</h2><pre><code># 进入虚拟环境，没有用conda安装

# conda activate drep
source $&#123;soft&#125;/bin/activate drep
cd $&#123;wd&#125;/binning
</code></pre>
<p>合并所有bin至同一目录</p>
<pre><code>mkdir -p temp/drep_in
# 混合组装分箱并重命名
ln -s `pwd`/temp/bin_refinement/metawrap_50_10_bins/bin.* temp/drep_in/
rename &#39;bin&#39; &#39;mix_all&#39; temp/drep_in/bin.*

# 单样品组装分箱结果重命名
for i in `ls seq/|cut -f1 -d &#39;_&#39;|uniq`;do
   ln -s `pwd`/temp/bin_refinement_$&#123;i&#125;/metawrap_50_10_bins/bin.* temp/drep_in/
   rename &quot;bin.&quot; &quot;s_$&#123;i&#125;&quot; temp/drep_in/bin.*
done
# 统计混合和单样本来源数据，10个混，5个单
ls temp/drep_in/|cut -f 1 -d &#39;_&#39;|uniq -c
# 统计混合批次/单样本来源
ls temp/drep_in/|cut -f 2 -d &#39;_&#39;|cut -f 1 -d &#39;.&#39; |uniq -c
</code></pre>
<p>按种水平去冗余：15个为10个，8个来自混拼，2个来自单拼</p>
<pre><code>mkdir -p temp/drep95
# 15个，40min
dRep dereplicate temp/drep95/ \
  -g temp/drep_in/*.fa \
  -sa 0.95 -nc 0.30 -comp 50 -con 10 -p 3
</code></pre>
<p>主要结果：</p>
<ul>
<li>非冗余基因组集：dereplicated_genomes/*.fa</li>
<li>聚类信息表：data_tables/Cdb.csv</li>
<li>聚类和质量图：firgures/<em>clustering</em></li>
</ul>
<p>(可选)按株水平汇总</p>
<pre><code># 20-30min
mkdir -p temp/drep95
dRep dereplicate temp/drep95/ \
  -g temp/drep_in/*.fa \
  -sa 0.99 -nc 0.30 -comp 50 -con 10 -p 24
</code></pre>
<h2 id="4-3-GTDB-tk物种注释和进化树"><a href="#4-3-GTDB-tk物种注释和进化树" class="headerlink" title="4.3 GTDB-tk物种注释和进化树"></a>4.3 GTDB-tk物种注释和进化树</h2><p>启动软件所在虚拟环境</p>
<pre><code># gtdbtk与drep安装在了同一个环境
# conda activate gtdbtk
</code></pre>
<p>细菌基因组物种注释</p>
<p>以上面鉴定的10个种为例，注意扩展名要与输入文件一致，可使用压缩格式gz。主要结果文件描述：此9个细菌基因组，结果位于tax.bac120开头的文件，如物种注释 tax.bac120.summary.tsv。古菌结果位于tax.ar122开头的文件中。</p>
<pre><code>mkdir -p temp/gtdb_classify
# 10个基因组，24p，100min 152 G内存
gtdbtk classify_wf \
    --genome_dir temp/drep95/dereplicated_genomes \
    --out_dir temp/gtdb_classify \
    --extension fa \
    --prefix tax \
    --cpus 10
</code></pre>
<p>多序列对齐结果建树</p>
<pre><code># 以9个细菌基因组的120个单拷贝基因建树，1s
mkdir -p temp/gtdb_infer
gtdbtk infer \
    --msa_file temp/gtdb_classify/tax.bac120.user_msa.fasta \
    --out_dir temp/gtdb_infer \
    --prefix tax \
    --cpus 2
</code></pre>
<p>树文件可使用iTOL在线美化，也可使用GraphLan本地美化。</p>
<h2 id="4-4-table2itol制作树注释文件"><a href="#4-4-table2itol制作树注释文件" class="headerlink" title="4.4 table2itol制作树注释文件"></a>4.4 table2itol制作树注释文件</h2><p>以gtdb-tk物种注释(tax.bac120.summary.tsv)和drep基因组评估(Widb.csv)信息为注释信息</p>
<pre><code>mkdir -p result/itol
# 制作分类学表
tail -n+2 temp/gtdb_classify/tax.bac120.summary.tsv|cut -f 1-2|sed &#39;s/;/\t/g&#39;|sed &#39;1 s/^/ID\tDomain\tPhylum\tClass\tOrder\tFamily\tGenus\tSpecies\n/&#39; \
  &gt; result/itol/tax.txt
# 基因组评估信息
sed &#39;s/,/\t/g;s/.fa//&#39; temp/drep95/data_tables/Widb.csv|cut -f 1-7,11|sed &#39;1 s/genome/ID/&#39; \
  &gt; result/itol/genome.txt
# 整合注释文件
awk &#39;BEGIN&#123;OFS=FS=&quot;\t&quot;&#125; NR==FNR&#123;a[$1]=$0&#125; NR&gt;FNR&#123;print $0,a[$1]&#125;&#39; result/itol/genome.txt result/itol/tax.txt|cut -f 1-8,10- &gt; result/itol/annotation.txt
</code></pre>
<p>table2itol制作注释文件</p>
<pre><code>cd result/itol/
# 设置脚本位置
db=/disk1/db/script/table2itol/
#db=/db

## 方案1. 分类彩带、数值热图、种标签
# -a 找不到输入列将终止运行（默认不执行）-c 将整数列转换为factor或具有小数点的数字，-t 偏离提示标签时转换ID列，-w 颜色带，区域宽度等， -D输出目录，-i OTU列名，-l 种标签替换ID
# Fatal error: ??????&#39;./table2itol-master/table2itol.R&#39;: ?????????
Rscript $&#123;db&#125;/table2itol.R -a -c double -D plan1 -i ID -l Species -t %s -w 0.5 annotation.txt
# 生成注释文件中每列为单独一个文件

## 方案2. 数值柱形图，树门背景色，属标签
Rscript $&#123;db&#125;/table2itol.R -a -d -c none -D plan2 -b Phylum -i ID -l Genus -t %s -w 0.5 annotation.txt

## 方案3.分类彩带、整数为柱、小数为热图
Rscript $&#123;db&#125;/table2itol.R -c keep -D plan3 -i ID -t %s annotation.txt

## 方案4. 将整数转化成因子生成注释文件
Rscript $&#123;db&#125;/table2itol.R -a -c factor -D plan4 -i ID -l Genus -t %s -w 0 annotation.txt
</code></pre>
<h2 id="4-5-PROKKA单菌基因组功能注释"><a href="#4-5-PROKKA单菌基因组功能注释" class="headerlink" title="4.5 PROKKA单菌基因组功能注释"></a>4.5 PROKKA单菌基因组功能注释</h2><pre><code>conda activate metawrap
export PERL_5LIB=$&#123;PERL5LIB&#125;:$&#123;soft&#125;/envs/metawrap/lib/perl5/site_perl/5.22.0/
i=bin1
time prokka result/contig/$&#123;db&#125;.fa \
  --kingdom Archaea,Bacteria --cpus 9 \
  --outdir temp/prokka/$&#123;db&#125; 
</code></pre>
<h1 id="附录：常见分析问题和经验"><a href="#附录：常见分析问题和经验" class="headerlink" title="附录：常见分析问题和经验"></a>附录：常见分析问题和经验</h1><h2 id="质控KneadData"><a href="#质控KneadData" class="headerlink" title="质控KneadData"></a>质控KneadData</h2><h3 id="双端序列质控后是否配对的检查"><a href="#双端序列质控后是否配对的检查" class="headerlink" title="双端序列质控后是否配对的检查"></a>双端序列质控后是否配对的检查</h3><p>双端序列质控后序列数量不一致是肯定出错了。但即使序列数量一致，也可能序列不对。在运行metawrap分箱时会报错。可以kneaddata运行时添加–reorder来尝试解决。以下提供了检查双端序列ID是否配对的比较代码</p>
<pre><code># 文件
i=sample1
seqkit seq -n -i temp/qc/$&#123;i&#125;_1_kneaddata_paired_1.fastq|cut -f 1 -d &#39;/&#39; | head &gt; temp/header_$&#123;i&#125;_1
seqkit seq -n -i temp/qc/$&#123;i&#125;_1_kneaddata_paired_2.fastq|cut -f 1 -d &#39;/&#39; | head &gt; temp/header_$&#123;i&#125;_2
cmp temp/header_$&#123;i&#125;_?
</code></pre>
<h3 id="Perl环境不匹配"><a href="#Perl环境不匹配" class="headerlink" title="Perl环境不匹配"></a>Perl环境不匹配</h3><p>报错’perl binaries are mismatched’的解决</p>
<pre><code>e=~/miniconda3/envs/meta
PERL5LIB=$&#123;e&#125;/lib/5.26.2:$&#123;e&#125;/lib/5.26.2/x86_64-linux-thread-multi
</code></pre>
<h3 id="Java不匹配——重装Java运行环境"><a href="#Java不匹配——重装Java运行环境" class="headerlink" title="Java不匹配——重装Java运行环境"></a>Java不匹配——重装Java运行环境</h3><p>若出现错误 Unrecognized option: -d64，则安装java解决：</p>
<pre><code>conda install -c cyclus java-jdk
</code></pre>
<h2 id="读长分析HUMAnN2"><a href="#读长分析HUMAnN2" class="headerlink" title="读长分析HUMAnN2"></a>读长分析HUMAnN2</h2><h3 id="HUMAnN2减少输出文件加速"><a href="#HUMAnN2减少输出文件加速" class="headerlink" title="HUMAnN2减少输出文件加速"></a>HUMAnN2减少输出文件加速</h3><p>HUMAnN2是计算非常耗时的步骤，如果上百个10G+的样本，有时需要几周至几月的分析。以下介绍两种快速完成分析，而且结果变化不大的方法。替换下面for循环为原文中的“双端合并为单个文件”部分代码</p>
<p>方法1. 软件分析不考虑双端信息，只用一端可获得相近结果，且速度提高1倍。链接质控结果左端高质量至合并目录</p>
<pre><code>for i in `tail -n+2 result/metadata.txt|cut -f1`;do 
  ln -sf `pwd`/temp/qc/$&#123;i&#125;_1_kneaddata_paired_1.fastq temp/concat/$&#123;i&#125;.fq
done
</code></pre>
<p>方法2. 控制标准样比对时间。测序数据量通常为6<del>50G，同一样本分析时间可达10h</del>100h，严重浪费时间而浪费硬盘空间。<br>可用head对单端分析截取20M序列，即3G，则为80M行</p>
<pre><code>for i in `tail -n+2 result/metadata.txt|cut -f1`;do 
   head -n80000000 temp/qc/$&#123;i&#125;_1_kneaddata_paired_1.fastq  &gt; temp/concat/$&#123;i&#125;.fq
done
</code></pre>
<h3 id="metaphlan2无法找到数据库"><a href="#metaphlan2无法找到数据库" class="headerlink" title="metaphlan2无法找到数据库"></a>metaphlan2无法找到数据库</h3><p>正常在首次运行时，会自动下载数据库。有时会失败，解决方法：</p>
<p>方法1. 使用软件安装的用户运行一下程序即可下载成功</p>
<p>方法2. 将我们预下载好的数据索引文件,链接到软件安装目录</p>
<pre><code>db=~/db
soft=~/miniconda2
mkdir -p $&#123;soft&#125;/bin/db_v20
ln -s $&#123;db&#125;/metaphlan2/* $&#123;soft&#125;/bin/db_v20/
mkdir -p $&#123;soft&#125;/bin/databases
ln -s $&#123;db&#125;/metaphlan2/* $&#123;soft&#125;/bin/databases/
</code></pre>
<h3 id="CRITICAL-ERROR-Can-not-call-software-version-for-bowtie2"><a href="#CRITICAL-ERROR-Can-not-call-software-version-for-bowtie2" class="headerlink" title="CRITICAL ERROR: Can not call software version for bowtie2"></a>CRITICAL ERROR: Can not call software version for bowtie2</h3><p>解决问题思路：</p>
<p>查看文件位置是否处在conda环境中：<code>type bowtie2</code>。如果不在需要手动设置环境变量的顺序，如果位置正确如在(~/miniconda2/envs/humann2/bin/bowtie2)，请往下看；</p>
<p>检测bowtie2运行情况：<code>bowtie2 -h</code>，报错<code>wd.c: loadable library and perl binaries are mismatched (got handshake key 0xde00080, needed 0xed00080)</code>。 错误原因为Perl库版本错误，检查Perl库位置：<code>echo $PERL5LIB</code>，错误原因没有指向环境，并手动修改perl库位置</p>
<pre><code># 设置你环境变量位置，最好用绝对路径
e=~/miniconda2/envs/humann2
PERL5LIB=$&#123;e&#125;/lib/5.26.2:$&#123;e&#125;/lib/5.26.2/x86_64-linux-thread-multi
</code></pre>
<h3 id="metaphlan-hclust-heatmap-py报错AttributeError-Unknown-property-axisbg"><a href="#metaphlan-hclust-heatmap-py报错AttributeError-Unknown-property-axisbg" class="headerlink" title="metaphlan_hclust_heatmap.py报错AttributeError: Unknown property axisbg"></a>metaphlan_hclust_heatmap.py报错AttributeError: Unknown property axisbg</h3><p>在网上搜索，axisbg和axis_bgcolor为过时的函数，新版为facecolor，修改为新名称即可 (参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41185868/article/details/81842971">https://blog.csdn.net/qq_41185868/article/details/81842971</a>)</p>
<pre><code># 定位文件绝对路径
file=`type metaphlan_hclust_heatmap.py|cut -f 2 -d &#39;(&#39;|sed &#39;s/)//&#39;`
# 替换函数名称为新版
sed -i &#39;s/axisbg/facecolor/g&#39; $file
</code></pre>
<h3 id="metaphlan2-共有或特有物种网络图"><a href="#metaphlan2-共有或特有物种网络图" class="headerlink" title="metaphlan2-共有或特有物种网络图"></a>metaphlan2-共有或特有物种网络图</h3><pre><code>awk &#39;BEGIN&#123;OFS=FS=&quot;\t&quot;&#125;&#123;if(FNR==1) &#123;for(i=9;i&lt;=NF;i++) a[i]=$i; print &quot;Tax\tGroup&quot;&#125; \
   else &#123;for(i=9;i&lt;=NF;i++) if($i&gt;0.05) print &quot;Tax_&quot;FNR, a[i];&#125;&#125;&#39; \
   result/metaphlan2/taxonomy.spf &gt; result/metaphlan2/taxonomy_highabundance.tsv
   
awk &#39;BEGIN&#123;OFS=FS=&quot;\t&quot;&#125;&#123;if(FNR==1) &#123;print &quot;Tax\tGrpcombine&quot;;&#125; else a[$1]=a[$1]==&quot;&quot;?$2:a[$1]$2;&#125;END&#123;for(i in a) print i,a[i]&#125;&#39; \
   result/metaphlan2/taxonomy_highabundance.tsv &gt; result/metaphlan2/taxonomy_group.tsv

cut -f 2 result/metaphlan2/taxonomy_group.tsv | tail -n +2 | sort -u &gt;group

for i in `cat group`; do printf &quot;#%02x%02x%02x\n&quot; $((RANDOM%256)) $((RANDOM%256)) $((RANDOM%256)); done &gt;colorcode

paste group colorcode &gt;group_colorcode

awk &#39;BEGIN&#123;OFS=FS=&quot;\t&quot;&#125;ARGIND==1&#123;a[$1]=$2;&#125;ARGIND==2&#123;if(FNR==1) &#123;print $0, &quot;Grpcombinecolor&quot;&#125; else print $0,a[$2]&#125;&#39; \
   group_colorcode result/metaphlan2/taxonomy_group.tsv &gt; result/metaphlan2/taxonomy_group2.tsv

awk &#39;BEGIN&#123;OFS=FS=&quot;\t&quot;&#125;&#123;if(FNR==1) &#123;print &quot;Tax&quot;,$1,$2,$3,$4, $5, $6, $7, $8 &#125; else print &quot;Tax_&quot;FNR, $1,$2,$3,$4, $5,$6, $7, $8&#125;&#39; \
   result/metaphlan2/taxonomy.spf &gt; result/metaphlan2/taxonomy_anno.tsv
</code></pre>
<h2 id="生物标志鉴定LEfSe"><a href="#生物标志鉴定LEfSe" class="headerlink" title="生物标志鉴定LEfSe"></a>生物标志鉴定LEfSe</h2><h3 id="lefse-plot-cladogram-py：Unknown-property-axis-bgcolor"><a href="#lefse-plot-cladogram-py：Unknown-property-axis-bgcolor" class="headerlink" title="lefse-plot_cladogram.py：Unknown property axis_bgcolor"></a>lefse-plot_cladogram.py：Unknown property axis_bgcolor</h3><p>若出现错误 Unknown property axis_bgcolor，则修改<code>lefse-plot_cladogram.py</code>里的<code>ax_bgcolor</code>替换成<code>facecolor</code>即可。</p>
<pre><code># 查看脚本位置，然后使用RStudio或Vim修改
type lefse-plot_cladogram.py
</code></pre>
<h2 id="物种分类Kraken2"><a href="#物种分类Kraken2" class="headerlink" title="物种分类Kraken2"></a>物种分类Kraken2</h2><h3 id="合并样本为表格combine-mpa-py"><a href="#合并样本为表格combine-mpa-py" class="headerlink" title="合并样本为表格combine_mpa.py"></a>合并样本为表格combine_mpa.py</h3><p>krakentools中combine_mpa.py，需手动安装脚本，且结果还需调整样本名</p>
<pre><code>combine_mpa.py \
  -i `tail -n+2 result/metadata.txt|cut -f1|sed &#39;s/^/temp\/kraken2\//;s/$/.mpa/&#39;|tr &#39;\n&#39; &#39; &#39;` \
  -o temp/kraken2/combined_mpa
</code></pre>
<h3 id="序列筛选-去宿主extract-kraken-reads-py"><a href="#序列筛选-去宿主extract-kraken-reads-py" class="headerlink" title="序列筛选/去宿主extract_kraken_reads.py"></a>序列筛选/去宿主extract_kraken_reads.py</h3><p>提取非植物33090和动物(人)33208序列、选择细菌2和古菌2157</p>
<pre><code>mkdir -p temp/kraken2_qc
parallel -j 3 \
  &quot;/db/script/extract_kraken_reads.py \
  -k temp/kraken2/&#123;1&#125;.output \
  -r temp/kraken2/&#123;1&#125;.report \
  -1 temp/qc/&#123;1&#125;_1_kneaddata_paired_1.fastq \
  -2 temp/qc/&#123;1&#125;_1_kneaddata_paired_2.fastq \
  -t 33090 33208 --include-children --exclude \
  --max 20000000 --fastq-output \
  -o temp/kraken2_qc/&#123;1&#125;_1.fq \
  -o2 temp/kraken2_qc/&#123;1&#125;_2.fq&quot; \
  ::: `tail -n+2 result/metadata.txt|cut -f1`
</code></pre>
<h2 id="组装Megahit"><a href="#组装Megahit" class="headerlink" title="组装Megahit"></a>组装Megahit</h2><h3 id="序列长度筛选"><a href="#序列长度筛选" class="headerlink" title="序列长度筛选"></a>序列长度筛选</h3><p>megahit默认&gt;200，可选 &gt; 500 / 1000 bp，并统计前后变化；如此处筛选 &gt; 500 bp，序列从15万变为3.5万条，总长度从7M下降到3M</p>
<pre><code>mv temp/megahit/final.contigs.fa temp/megahit/raw.contigs.fa
seqkit seq -m 500 temp/megahit/raw.contigs.fa &gt; temp/megahit/final.contigs.fa
seqkit stat temp/megahit/raw.contigs.fa
seqkit stat temp/megahit/final.contigs.fa
</code></pre>
<h3 id="数据太大导致程序中断"><a href="#数据太大导致程序中断" class="headerlink" title="数据太大导致程序中断"></a>数据太大导致程序中断</h3><p>报错信息：126 - Too many vertices in the unitig graph (8403694648 &gt;= 4294967294), you may increase the kmer size to remove tons</p>
<p>解决方法：需要增加k-mer，如最小k-mer改为29，不行继续增加或将数据分批次组装</p>
<p>添加参数： –k-min 29 –k-max 141 –k-step 20</p>
<h2 id="组装MetaSpdades"><a href="#组装MetaSpdades" class="headerlink" title="组装MetaSpdades"></a>组装MetaSpdades</h2><h3 id="二三代混合组装"><a href="#二三代混合组装" class="headerlink" title="二三代混合组装"></a>二三代混合组装</h3><pre><code># 3G数据，耗时3h
i=SampleA
time metaspades.py -t 48 -m 500 \
  -1 seq/$&#123;i&#125;_1.fastq -2 seq/$&#123;i&#125;L_2.fastq \
  --nanopore seq/$&#123;i&#125;.fastq \
  -o temp/metaspades_$&#123;i&#125;
</code></pre>
<h2 id="二三代混合组装OPERA-MS"><a href="#二三代混合组装OPERA-MS" class="headerlink" title="二三代混合组装OPERA-MS"></a>二三代混合组装OPERA-MS</h2><p>结果卡在第9步polishing，可添加–no-polishing参数跳过此步；短序列只支持成对文件，多个文件需要cat合并</p>
<h3 id="二三代混合组装-1"><a href="#二三代混合组装-1" class="headerlink" title="二三代混合组装"></a>二三代混合组装</h3><pre><code>perl ../OPERA-MS.pl \
    --short-read1 R1.fastq.gz \
    --short-read2 R2.fastq.gz \
    --long-read long_read.fastq \
    --no-ref-clustering \
    --num-processors 32 \
    --out-dir RESULTS
</code></pre>
<h3 id="二代组装-三代优化"><a href="#二代组装-三代优化" class="headerlink" title="二代组装+三代优化"></a>二代组装+三代优化</h3><pre><code>perl ~/soft/OPERA-MS/OPERA-MS.pl \
    --contig-file temp/megahit/final.contigs.fa \
    --short-read1 R1.fastq.gz \
    --short-read2 R2.fastq.gz \
    --long-read long_read.fastq \
    --num-processors 32 \
    --no-ref-clustering \
    --no-strain-clustering \
    --no-polishing \
    --out-dir temp/opera
</code></pre>
<p>结果可用quast或seqkit stat统计对二代组装的改进效果</p>
<h2 id="基因序列prodigal"><a href="#基因序列prodigal" class="headerlink" title="基因序列prodigal"></a>基因序列prodigal</h2><h3 id="序列拆分并行预测基因"><a href="#序列拆分并行预测基因" class="headerlink" title="序列拆分并行预测基因"></a>序列拆分并行预测基因</h3><p>(可选)以上注释大约1小时完成1M个基因的预测。加速可将contigs拆分，并行基因预测后再合并。</p>
<pre><code># 拆分contigs，按1M条每个文件
n=10000
seqkit split result/megahit/final.contigs.fa -s $n
# 生成拆分文件序列列表
ls result/megahit/final.contigs.fa.split/final.contigs.part_*.fa|cut -f 2 -d &#39;_&#39;|cut -f 1 -d &#39;.&#39; \
  &gt; temp/split.list
# 9线程并行基因预测，此步只用单线程且读写强度不大
time parallel -j 9 \
  &quot;prodigal -i result/megahit/final.contigs.fa.split/final.contigs.part_&#123;&#125;.fa \
  -d temp/gene&#123;&#125;.fa  \
  -o temp/gene&#123;&#125;.gff -p meta -f gff \
  &gt; temp/gene&#123;&#125;.log 2&gt;&amp;1 &quot; \
  ::: `cat temp/split.list`
# 合并预测基因和gff注释文件
cat temp/gene*.fa &gt; temp/prodigal/gene.fa
cat temp/gene*.gff &gt; temp/prodigal/gene.gff
</code></pre>
<h2 id="基因去冗余cd-hit"><a href="#基因去冗余cd-hit" class="headerlink" title="基因去冗余cd-hit"></a>基因去冗余cd-hit</h2><h3 id="两批基因合并cd-hit-est-2d"><a href="#两批基因合并cd-hit-est-2d" class="headerlink" title="两批基因合并cd-hit-est-2d"></a>两批基因合并cd-hit-est-2d</h3><p>cd-hit-est-2d 两批次构建非冗余基因集</p>
<p>A和B基因集，分别有M和N个非冗余基因，两批数据合并后用cd-hit-est去冗余，计算量是(M + N) X (M + N -1)</p>
<p>cd-hit-est-2d比较，只有M X N的计算量</p>
<pre><code># 计算B中特有的基因
cd-hit-est-2d -i A.fa -i2 B.fa -o B.uni.fa \
    -aS 0.9 -c 0.95 -G 0 -g 0 \
    -T 96 -M 0 -d 0
# 合并为非冗余基因集
cat A.fa B.uni.fa &gt; NR.fa
</code></pre>
<h3 id="cd-hit合并多批基因salmon索引时提示ID重复"><a href="#cd-hit合并多批基因salmon索引时提示ID重复" class="headerlink" title="cd-hit合并多批基因salmon索引时提示ID重复"></a>cd-hit合并多批基因salmon索引时提示ID重复</h3><pre><code># [error] In FixFasta, two references with the same name but different sequences: k141_2390219_1. We require that all input records have a unique name up to the first whitespace (or user-provided separator) character.
# 错误解决
mv temp/NRgene/gene.fa temp/NRgene/gene.fa.bak
# 15G,2m,4G
seqkit rename temp/NRgene/gene.fa.bak -o temp/NRgene/gene.fa
</code></pre>
<h2 id="基因定量salmon"><a href="#基因定量salmon" class="headerlink" title="基因定量salmon"></a>基因定量salmon</h2><h3 id="找不到库文件liblzma-so-0"><a href="#找不到库文件liblzma-so-0" class="headerlink" title="找不到库文件liblzma.so.0"></a>找不到库文件liblzma.so.0</h3><ul>
<li>报错信息：error while loading shared libraries: liblzma.so.0</li>
<li>问题描述：直接运行salmon报告，显示找不到lib库，</li>
<li>解决方法：可使用程序完整路径解决问题，<code>alias salmon=&quot;$&#123;soft&#125;/envs/metagenome_env/share/salmon/bin/salmon&quot;</code></li>
</ul>
<h2 id="基因功能数据库"><a href="#基因功能数据库" class="headerlink" title="基因功能数据库"></a>基因功能数据库</h2><h3 id="综合功能注释KEGG描述整理"><a href="#综合功能注释KEGG描述整理" class="headerlink" title="综合功能注释KEGG描述整理"></a>综合功能注释KEGG描述整理</h3><p>脚本位于 /db/script 目录，<a target="_blank" rel="noopener" href="https://www.kegg.jp/kegg-bin/show_brite?ko00001.keg">https://www.kegg.jp/kegg-bin/show_brite?ko00001.keg</a> 下载htext，即为最新输入文件 ko00001.keg</p>
<pre><code>kegg_ko00001_htext2tsv.pl -i ko00001.keg -o ko00001.tsv
</code></pre>
<h3 id="抗生素抗性CARD"><a href="#抗生素抗性CARD" class="headerlink" title="抗生素抗性CARD"></a>抗生素抗性CARD</h3><pre><code># 使用3.1.0和3.1.2均有警告，修改序列名至纯字母数数字也无效
# WARNING 2021-07-08 08:58:00,478 : Exception : &lt;class &#39;KeyError&#39;&gt; -&gt; &#39;5141&#39; -&gt; Model(1692) missing in database. Please generate new database.
# WARNING 2021-07-08 08:58:00,478 : Exception : &lt;class &#39;KeyError&#39;&gt; -&gt; &#39;5141&#39; -&gt; Model(1692)
# WARNING 2021-07-08 08:58:00,479 : tetM ---&gt; hsp.bits: 60.8 &lt;class &#39;float&#39;&gt; ? &lt;class &#39;str&#39;&gt;
</code></pre>
<h3 id="抗生素抗性ResFam"><a href="#抗生素抗性ResFam" class="headerlink" title="抗生素抗性ResFam"></a>抗生素抗性ResFam</h3><p>数据库：<a target="_blank" rel="noopener" href="http://www.dantaslab.org/resfams">http://www.dantaslab.org/resfams</a></p>
<p>参考文献：<a target="_blank" rel="noopener" href="http://doi.org/10.1038/ismej.2014.106">http://doi.org/10.1038/ismej.2014.106</a></p>
<pre><code>mkdir -p temp/resfam result/resfam
# 比对至抗生素数据库 1m
time diamond blastp \
  --db $&#123;db&#125;/resfam/Resfams-proteins \
  --query result/NR/protein.fa \
  --threads 9 --outfmt 6 --sensitive \
  -e 1e-5 --max-target-seqs 1 --quiet \
  --out temp/resfam/gene_diamond.f6
# 提取基因对应抗性基因列表
cut -f 1,2 temp/resfam/gene_diamond.f6 | uniq | \
  sed &#39;1 i Name\tResGeneID&#39; &gt; temp/resfam/gene_fam.list
# 统计注释基因的比例, 488/19182=2.5%
wc -l temp/resfam/gene_fam.list  result/salmon/gene.count 
# 按列表累计丰度
summarizeAbundance.py \
  -i result/salmon/gene.TPM \
  -m temp/resfam/gene_fam.list \
  -c 2 -s &#39;,&#39; -n raw \
  -o result/resfam/TPM
# 结果中添加FAM注释，spf格式用于stamp分析
awk &#39;BEGIN&#123;FS=OFS=&quot;\t&quot;&#125; NR==FNR&#123;a[$1]=$4&quot;\t&quot;$3&quot;\t&quot;$2&#125; NR&gt;FNR&#123;print a[$1],$0&#125;&#39; \
  $&#123;db&#125;/resfam/Resfams-proteins_class.tsv  result/resfam/TPM.ResGeneID.raw.txt \
  &gt; result/resfam/TPM.ResGeneID.raw.spf
</code></pre>
<h2 id="细菌基因组物种注释GTDB"><a href="#细菌基因组物种注释GTDB" class="headerlink" title="细菌基因组物种注释GTDB"></a>细菌基因组物种注释GTDB</h2><p>菌的文件名不要存在非字母数字的符号，否则运行会报错。</p>
<pre><code># ERROR: [&#39;BMN5&#39;] are not present in the input list of genome to process，但并无此菌，可能是名称 中存在&quot;-&quot;或&quot;.&quot;，替换为i
# 修改metadata
sed &#39;s/-/i/;s/\./i/&#39; result/metadatab.txt &gt; result/metadata.txt
# 修改文件名
awk &#39;BEGIN&#123;OFS=FS=&quot;\t&quot;&#125;&#123;system(&quot;mv temp/antismash/&quot;$1&quot;.fna temp/antismash/&quot;$2&quot;.fna&quot;)ll &#125;&#39; &lt;(paste result/metadatab.txt result/metadata.txt|tail -n+2)
</code></pre>
<h1 id="版本更新记录"><a href="#版本更新记录" class="headerlink" title="版本更新记录"></a>版本更新记录</h1><h2 id="1-08-2020-7-20"><a href="#1-08-2020-7-20" class="headerlink" title="1.08 2020.7.20"></a>1.08 2020.7.20</h2><ol>
<li>KneadData提供数据预处理双端标签唯一命令，兼容最新版；</li>
<li>提供HUMAnN3测试版的安装和分析流程(附录1)；</li>
<li>eggNOG升级为emapper 2.0和eggNOG 5.0流程，结果列表从13列变为22列，新增CAZy注释。emapper 1.0版本见附录2。</li>
</ol>
<h2 id="1-09-2020-10-16"><a href="#1-09-2020-10-16" class="headerlink" title="1.09 2020.10.16"></a>1.09 2020.10.16</h2><ol>
<li>新增二、三代混合组装OPERA-MS软件使用 (31Megahit)</li>
<li>新增eggNOG-mapper结果COG/KO/CAZy整理脚本summarizeAbundance.py，删除旧版Shell+R代码 (32Annotation)</li>
<li>新增MetaWRAP单样本分箱流程 (33Binning)</li>
<li>新增dRep实现基因组去冗余 (34Genomes)</li>
<li>新增GTDB-Tk基因组物种注释和进化树构建 (34Genomes)</li>
</ol>
<h2 id="1-10-2021-1-22"><a href="#1-10-2021-1-22" class="headerlink" title="1.10 2021.1.22"></a>1.10 2021.1.22</h2><ol>
<li>增加删除中间文件部分，节约空间，防止硬盘写满；</li>
<li>正文的补充分析方法、常见问题移至附录，按软件名、问题/方法分级索引；</li>
<li>软件使用前，增加检查软件版本命令，方便文章方法中撰写准确版本；</li>
<li>删除不稳定的humann3、过时的eggnog版本教程；</li>
<li>增加kraken2新环境, 增加bracken, krakentools新工具；</li>
<li>kraken2结果新增beta多样性PCoA，物种组成堆叠柱状图；</li>
<li>增metaspades二、三代组装代码示例；</li>
<li>新增KEGG层级注释整理代码；</li>
<li>更新dbCAN2中2018版为2020版；</li>
<li>新增CARD本地分析流程；</li>
</ol>
<h2 id="1-11-2021-5-7"><a href="#1-11-2021-5-7" class="headerlink" title="1.11 2021.5.7"></a>1.11 2021.5.7</h2><ol>
<li>增加prodigal基因预测并行版方法，使用seqkit split拆分后并行，数10倍加速单线程基因预测步骤；</li>
<li>增加megahit拼装结果片段大小选择步骤，使用seqkit -m按长度筛选，并统计筛选前后变化；</li>
<li>不常用或可选代码调整到附录</li>
<li>两批数据快速合并去冗余cd-hit-est-2d</li>
<li>二三代混合组装OPERA-MS的混装和3代优化代码</li>
</ol>
<h4 id="1-12-2021-8-20"><a href="#1-12-2021-8-20" class="headerlink" title="1.12 2021.8.20"></a>1.12 2021.8.20</h4><ol>
<li>新增并行管理软件rush，比parallel更易安装，绿色版无依赖关系，整合在db/linux/目录中</li>
<li>新增seqkit，可以统计序列数据量，支持序列长度过滤，格式转换等；</li>
<li>新增质控软件fastp，软件fastqc更快，适合单独质控不去宿主；</li>
<li>kraken2新数据库，同样大小下注释率提高明显；</li>
<li>eggNOG软件和数据库配套升级</li>
<li>GTDB-tk软件和数据库需要配套重新才可使用新版25万基因组数据库</li>
</ol>
<h4 id="1-13-2021-11-19"><a href="#1-13-2021-11-19" class="headerlink" title="1.13 2021.11.19"></a>1.13 2021.11.19</h4><ol>
<li>陈同参与EasyMicrobiome的更新，并提交了mac版本代码</li>
<li>新增humann2运行bowtie2出错的解决方案</li>
</ol>
<h4 id="1-14-2022-3-25"><a href="#1-14-2022-3-25" class="headerlink" title="1.14 2022.3.25"></a>1.14 2022.3.25</h4><ol>
<li>EasyMicrobiome升级为1.14</li>
<li>升级miniconda2为miniconda3</li>
<li>dbcan2从2020/7/31的808M更新为2021/9/24版1016M，格式变化，配套format_dbcan2list.pl更新</li>
<li>新增eggnog环境，包含emapper 2.1.6，summarizeAbundance.py含pandas (conda install sklearn-pandas)，配套更新数据库</li>
<li>rgi更新到最新版及配套代码</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%94%9F%E7%89%A9%E4%BF%A1%E6%81%AF%E8%BD%AF%E4%BB%B6%E6%B5%81%E7%A8%8B/" rel="tag"># 生物信息软件流程</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/02/18/%E8%BF%99%E6%98%AF%E6%9C%80%E5%A5%BD%E7%9A%84%E6%97%B6%E4%BB%A3%EF%BC%8C%E4%B9%9F%E6%98%AF%E6%9C%80%E5%9D%8F%E7%9A%84%E6%97%B6%E4%BB%A3/" rel="prev" title="这是最好的时代，也是最坏的时代">
      <i class="fa fa-chevron-left"></i> 这是最好的时代，也是最坏的时代
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/01/LaTeX%E5%85%A5%E9%97%A8/" rel="next" title="LaTeX入门">
      LaTeX入门 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%98%93%E5%AE%8F%E5%9F%BA%E5%9B%A0%E7%BB%84%E6%B5%81%E7%A8%8BEasyMetagenomePipeline"><span class="nav-number">1.</span> <span class="nav-text">易宏基因组流程EasyMetagenomePipeline</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86-Data-preprocessing"><span class="nav-number">2.</span> <span class="nav-text">一、数据预处理 Data preprocessing</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-Prepare"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 准备工作 Prepare</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E8%AE%BE%E7%BD%AE-%E6%AF%8F%E6%AC%A1%E5%BC%80%E5%A7%8B%E5%88%86%E6%9E%90%E5%89%8D%E5%BF%85%E9%A1%BB%E8%BF%90%E8%A1%8C"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1.1 环境变量设置(每次开始分析前必须运行)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2-%E8%B5%B7%E5%A7%8B%E6%96%87%E4%BB%B6%E2%80%94%E2%80%94%E5%BA%8F%E5%88%97%E5%92%8C%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.2.</span> <span class="nav-text">1.1.2 起始文件——序列和元数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-3-%E4%BA%86%E8%A7%A3%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.3.</span> <span class="nav-text">1.1.3 了解工作目录和文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%8F%AF%E9%80%89-FastQC%E8%B4%A8%E9%87%8F%E8%AF%84%E4%BC%B0"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 (可选)FastQC质量评估</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E8%B4%A8%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 质量控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-1-Fastp%E8%B4%A8%E9%87%8F%E6%8E%A7%E5%88%B6%E7%8E%AF%E5%A2%83%E6%A0%B7%E5%93%81"><span class="nav-number">2.3.1.</span> <span class="nav-text">1.3.1 Fastp质量控制环境样品</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-2-KneadData%E8%B4%A8%E6%8E%A7%E5%92%8C%E5%8E%BB%E5%AE%BF%E4%B8%BB"><span class="nav-number">2.3.2.</span> <span class="nav-text">1.3.2 KneadData质控和去宿主</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E9%80%89-%E5%8D%95%E6%A0%B7%E5%93%81%E8%B4%A8%E6%8E%A7"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">(可选)单样品质控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E6%A0%B7%E5%93%81%E5%B9%B6%E8%A1%8C%E8%B4%A8%E6%8E%A7"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">多样品并行质控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B4%A8%E6%8E%A7%E7%BB%93%E6%9E%9C%E6%94%B9%E5%90%8D%E3%80%81%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E5%92%8C%E7%BB%9F%E8%AE%A1"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">质控结果改名、临时文件删除和统计</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E5%8F%AF%E9%80%89-%E8%B4%A8%E6%8E%A7%E5%90%8E%E8%B4%A8%E9%87%8F%E8%AF%84%E4%BC%B0"><span class="nav-number">2.4.</span> <span class="nav-text">1.4 (可选)质控后质量评估</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E4%BA%8E%E8%AF%BB%E9%95%BF%E5%88%86%E6%9E%90-Read-based-HUMAnN2"><span class="nav-number">3.</span> <span class="nav-text">二、基于读长分析 Read-based (HUMAnN2)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E5%87%86%E5%A4%87HUMAnN2%E8%BE%93%E5%85%A5%E6%96%87%E4%BB%B6"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 准备HUMAnN2输入文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-HUMAnN2%E8%AE%A1%E7%AE%97%E7%89%A9%E7%A7%8D%E5%92%8C%E5%8A%9F%E8%83%BD%E7%BB%84%E6%88%90"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 HUMAnN2计算物种和功能组成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E7%89%A9%E7%A7%8D%E7%BB%84%E6%88%90%E8%A1%A8"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 物种组成表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-%E6%A0%B7%E5%93%81%E7%BB%93%E6%9E%9C%E5%90%88%E5%B9%B6"><span class="nav-number">3.3.1.</span> <span class="nav-text">2.3.1 样品结果合并</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-%E8%BD%AC%E6%8D%A2%E4%B8%BAstamp%E7%9A%84spf%E6%A0%BC%E5%BC%8F"><span class="nav-number">3.3.2.</span> <span class="nav-text">2.3.2 转换为stamp的spf格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-%E5%8F%AF%E9%80%89-Python%E7%BB%98%E5%88%B6%E7%83%AD%E5%9B%BE"><span class="nav-number">3.3.3.</span> <span class="nav-text">2.3.3 (可选)Python绘制热图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E5%8A%9F%E8%83%BD%E7%BB%84%E6%88%90%E5%88%86%E6%9E%90"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 功能组成分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E5%8A%9F%E8%83%BD%E7%BB%84%E6%88%90%E5%90%88%E5%B9%B6%E3%80%81%E6%A0%87%E5%87%86%E5%8C%96%E5%92%8C%E5%88%86%E5%B1%82"><span class="nav-number">3.4.1.</span> <span class="nav-text">2.4.1 功能组成合并、标准化和分层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E5%B7%AE%E5%BC%82%E6%AF%94%E8%BE%83%E5%92%8C%E6%9F%B1%E7%8A%B6%E5%9B%BE"><span class="nav-number">3.4.2.</span> <span class="nav-text">2.4.2 差异比较和柱状图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-3-%E8%BD%AC%E6%8D%A2%E4%B8%BAKEGG%E6%B3%A8%E9%87%8A"><span class="nav-number">3.4.3.</span> <span class="nav-text">2.4.3 转换为KEGG注释</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-GraPhlAn%E5%9B%BE"><span class="nav-number">3.5.</span> <span class="nav-text">2.5 GraPhlAn图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-LEfSe%E5%B7%AE%E5%BC%82%E5%88%86%E6%9E%90%E7%89%A9%E7%A7%8D"><span class="nav-number">3.6.</span> <span class="nav-text">2.6 LEfSe差异分析物种</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7-Kraken2%E7%89%A9%E7%A7%8D%E6%B3%A8%E9%87%8A"><span class="nav-number">3.7.</span> <span class="nav-text">2.7 Kraken2物种注释</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-1-Kraken2%E7%89%A9%E7%A7%8D%E6%B3%A8%E9%87%8A"><span class="nav-number">3.7.1.</span> <span class="nav-text">2.7.1 Kraken2物种注释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-2-Bracken%E4%BC%B0%E8%AE%A1%E4%B8%B0%E5%BA%A6"><span class="nav-number">3.7.2.</span> <span class="nav-text">2.7.2 Bracken估计丰度</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E7%BB%84%E8%A3%85%E5%88%86%E6%9E%90%E6%B5%81%E7%A8%8B-Assemble-based"><span class="nav-number">4.</span> <span class="nav-text">三、组装分析流程 Assemble-based</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E6%8B%BC%E6%8E%A5-Assembly"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 拼接 Assembly</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-MEGAHIT%E6%8B%BC%E6%8E%A5"><span class="nav-number">4.1.1.</span> <span class="nav-text">3.1.1 MEGAHIT拼接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-%E5%8F%AF%E9%80%89-metaSPAdes%E7%B2%BE%E7%BB%86%E6%8B%BC%E6%8E%A5"><span class="nav-number">4.1.2.</span> <span class="nav-text">3.1.2 (可选) metaSPAdes精细拼接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-QUAST%E8%AF%84%E4%BC%B0"><span class="nav-number">4.1.3.</span> <span class="nav-text">3.1.3 QUAST评估</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%9F%BA%E5%9B%A0%E9%A2%84%E6%B5%8B%E3%80%81%E5%8E%BB%E5%86%97%E4%BD%99%E5%92%8C%E5%AE%9A%E9%87%8F"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 基因预测、去冗余和定量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-metaProdigal%E5%9F%BA%E5%9B%A0%E9%A2%84%E6%B5%8B"><span class="nav-number">4.2.1.</span> <span class="nav-text">3.2.1 metaProdigal基因预测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-%E5%9F%BA%E5%9B%A0%E8%81%9A%E7%B1%BB-%E5%8E%BB%E5%86%97%E4%BD%99cd-hit"><span class="nav-number">4.2.2.</span> <span class="nav-text">3.2.2 基因聚类&#x2F;去冗余cd-hit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-%E5%9F%BA%E5%9B%A0%E5%AE%9A%E9%87%8Fsalmon"><span class="nav-number">4.2.3.</span> <span class="nav-text">3.2.3 基因定量salmon</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%8A%9F%E8%83%BD%E5%9F%BA%E5%9B%A0%E6%B3%A8%E9%87%8A"><span class="nav-number">4.3.</span> <span class="nav-text">3.3 功能基因注释</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-%E5%9F%BA%E5%9B%A0%E6%B3%A8%E9%87%8AeggNOG-COG-KEGG-CAZy"><span class="nav-number">4.3.1.</span> <span class="nav-text">3.3.1 基因注释eggNOG(COG&#x2F;KEGG&#x2F;CAZy)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E5%8F%AF%E9%80%89-%E7%A2%B3%E6%B0%B4%E5%8C%96%E5%90%88%E7%89%A9dbCAN2"><span class="nav-number">4.3.2.</span> <span class="nav-text">3.3.2 (可选)碳水化合物dbCAN2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-%E6%8A%97%E7%94%9F%E7%B4%A0%E6%8A%97%E6%80%A7CARD"><span class="nav-number">4.3.3.</span> <span class="nav-text">3.3.3 抗生素抗性CARD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E5%9F%BA%E5%9B%A0%E7%89%A9%E7%A7%8D%E6%B3%A8%E9%87%8A"><span class="nav-number">4.4.</span> <span class="nav-text">3.4 基因物种注释</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%8C%96%E6%8E%98%E5%8D%95%E8%8F%8C%E5%9F%BA%E5%9B%A0%E7%BB%84-%E5%88%86%E7%AE%B1-Binning"><span class="nav-number">5.</span> <span class="nav-text">四、挖掘单菌基因组&#x2F;分箱(Binning)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-MetaWRAP"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 MetaWRAP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">5.1.1.</span> <span class="nav-text">4.1.1 准备数据和环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-%E8%BF%90%E8%A1%8C%E4%B8%89%E7%A7%8D%E5%88%86%E7%AE%B1%E8%BD%AF%E4%BB%B6"><span class="nav-number">5.1.2.</span> <span class="nav-text">4.1.2 运行三种分箱软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-3-Bin%E6%8F%90%E7%BA%AF"><span class="nav-number">5.1.3.</span> <span class="nav-text">4.1.3 Bin提纯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-4-Bin%E5%AE%9A%E9%87%8F"><span class="nav-number">5.1.4.</span> <span class="nav-text">4.1.4 Bin定量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-5-Bin%E6%B3%A8%E9%87%8A"><span class="nav-number">5.1.5.</span> <span class="nav-text">4.1.5 Bin注释</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E9%80%89-MetaWRAP%E5%8D%95%E6%A0%B7%E6%9C%AC%E5%88%86%E5%88%AB%E7%BB%84%E8%A3%85%E5%92%8C%E5%88%86%E7%AE%B1"><span class="nav-number">5.2.</span> <span class="nav-text">(可选)MetaWRAP单样本分别组装和分箱</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AE%BE%E5%AE%9A"><span class="nav-number">5.2.1.</span> <span class="nav-text">参数设定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-megahit%E7%BB%84%E8%A3%85"><span class="nav-number">5.2.2.</span> <span class="nav-text">1 megahit组装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%BF%90%E8%A1%8C%E4%B8%89%E7%A7%8Dbin%E8%BD%AF%E4%BB%B6"><span class="nav-number">5.2.3.</span> <span class="nav-text">2 运行三种bin软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Bin%E6%8F%90%E7%BA%AF"><span class="nav-number">5.2.4.</span> <span class="nav-text">3 Bin提纯</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-dRep%E5%8E%BB%E5%86%97%E4%BD%99%E7%A7%8D-%E6%A0%AA%E5%9F%BA%E5%9B%A0%E7%BB%84%E9%9B%86"><span class="nav-number">5.3.</span> <span class="nav-text">4.2 dRep去冗余种&#x2F;株基因组集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-GTDB-tk%E7%89%A9%E7%A7%8D%E6%B3%A8%E9%87%8A%E5%92%8C%E8%BF%9B%E5%8C%96%E6%A0%91"><span class="nav-number">5.4.</span> <span class="nav-text">4.3 GTDB-tk物种注释和进化树</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-table2itol%E5%88%B6%E4%BD%9C%E6%A0%91%E6%B3%A8%E9%87%8A%E6%96%87%E4%BB%B6"><span class="nav-number">5.5.</span> <span class="nav-text">4.4 table2itol制作树注释文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-PROKKA%E5%8D%95%E8%8F%8C%E5%9F%BA%E5%9B%A0%E7%BB%84%E5%8A%9F%E8%83%BD%E6%B3%A8%E9%87%8A"><span class="nav-number">5.6.</span> <span class="nav-text">4.5 PROKKA单菌基因组功能注释</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95%EF%BC%9A%E5%B8%B8%E8%A7%81%E5%88%86%E6%9E%90%E9%97%AE%E9%A2%98%E5%92%8C%E7%BB%8F%E9%AA%8C"><span class="nav-number">6.</span> <span class="nav-text">附录：常见分析问题和经验</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A8%E6%8E%A7KneadData"><span class="nav-number">6.1.</span> <span class="nav-text">质控KneadData</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E7%AB%AF%E5%BA%8F%E5%88%97%E8%B4%A8%E6%8E%A7%E5%90%8E%E6%98%AF%E5%90%A6%E9%85%8D%E5%AF%B9%E7%9A%84%E6%A3%80%E6%9F%A5"><span class="nav-number">6.1.1.</span> <span class="nav-text">双端序列质控后是否配对的检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Perl%E7%8E%AF%E5%A2%83%E4%B8%8D%E5%8C%B9%E9%85%8D"><span class="nav-number">6.1.2.</span> <span class="nav-text">Perl环境不匹配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java%E4%B8%8D%E5%8C%B9%E9%85%8D%E2%80%94%E2%80%94%E9%87%8D%E8%A3%85Java%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="nav-number">6.1.3.</span> <span class="nav-text">Java不匹配——重装Java运行环境</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E9%95%BF%E5%88%86%E6%9E%90HUMAnN2"><span class="nav-number">6.2.</span> <span class="nav-text">读长分析HUMAnN2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HUMAnN2%E5%87%8F%E5%B0%91%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6%E5%8A%A0%E9%80%9F"><span class="nav-number">6.2.1.</span> <span class="nav-text">HUMAnN2减少输出文件加速</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#metaphlan2%E6%97%A0%E6%B3%95%E6%89%BE%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">6.2.2.</span> <span class="nav-text">metaphlan2无法找到数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CRITICAL-ERROR-Can-not-call-software-version-for-bowtie2"><span class="nav-number">6.2.3.</span> <span class="nav-text">CRITICAL ERROR: Can not call software version for bowtie2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#metaphlan-hclust-heatmap-py%E6%8A%A5%E9%94%99AttributeError-Unknown-property-axisbg"><span class="nav-number">6.2.4.</span> <span class="nav-text">metaphlan_hclust_heatmap.py报错AttributeError: Unknown property axisbg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#metaphlan2-%E5%85%B1%E6%9C%89%E6%88%96%E7%89%B9%E6%9C%89%E7%89%A9%E7%A7%8D%E7%BD%91%E7%BB%9C%E5%9B%BE"><span class="nav-number">6.2.5.</span> <span class="nav-text">metaphlan2-共有或特有物种网络图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E7%89%A9%E6%A0%87%E5%BF%97%E9%89%B4%E5%AE%9ALEfSe"><span class="nav-number">6.3.</span> <span class="nav-text">生物标志鉴定LEfSe</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lefse-plot-cladogram-py%EF%BC%9AUnknown-property-axis-bgcolor"><span class="nav-number">6.3.1.</span> <span class="nav-text">lefse-plot_cladogram.py：Unknown property axis_bgcolor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%A9%E7%A7%8D%E5%88%86%E7%B1%BBKraken2"><span class="nav-number">6.4.</span> <span class="nav-text">物种分类Kraken2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%88%E5%B9%B6%E6%A0%B7%E6%9C%AC%E4%B8%BA%E8%A1%A8%E6%A0%BCcombine-mpa-py"><span class="nav-number">6.4.1.</span> <span class="nav-text">合并样本为表格combine_mpa.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E7%AD%9B%E9%80%89-%E5%8E%BB%E5%AE%BF%E4%B8%BBextract-kraken-reads-py"><span class="nav-number">6.4.2.</span> <span class="nav-text">序列筛选&#x2F;去宿主extract_kraken_reads.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%84%E8%A3%85Megahit"><span class="nav-number">6.5.</span> <span class="nav-text">组装Megahit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E9%95%BF%E5%BA%A6%E7%AD%9B%E9%80%89"><span class="nav-number">6.5.1.</span> <span class="nav-text">序列长度筛选</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%AA%E5%A4%A7%E5%AF%BC%E8%87%B4%E7%A8%8B%E5%BA%8F%E4%B8%AD%E6%96%AD"><span class="nav-number">6.5.2.</span> <span class="nav-text">数据太大导致程序中断</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%84%E8%A3%85MetaSpdades"><span class="nav-number">6.6.</span> <span class="nav-text">组装MetaSpdades</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E4%B8%89%E4%BB%A3%E6%B7%B7%E5%90%88%E7%BB%84%E8%A3%85"><span class="nav-number">6.6.1.</span> <span class="nav-text">二三代混合组装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E4%B8%89%E4%BB%A3%E6%B7%B7%E5%90%88%E7%BB%84%E8%A3%85OPERA-MS"><span class="nav-number">6.7.</span> <span class="nav-text">二三代混合组装OPERA-MS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E4%B8%89%E4%BB%A3%E6%B7%B7%E5%90%88%E7%BB%84%E8%A3%85-1"><span class="nav-number">6.7.1.</span> <span class="nav-text">二三代混合组装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E4%BB%A3%E7%BB%84%E8%A3%85-%E4%B8%89%E4%BB%A3%E4%BC%98%E5%8C%96"><span class="nav-number">6.7.2.</span> <span class="nav-text">二代组装+三代优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E5%9B%A0%E5%BA%8F%E5%88%97prodigal"><span class="nav-number">6.8.</span> <span class="nav-text">基因序列prodigal</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E6%8B%86%E5%88%86%E5%B9%B6%E8%A1%8C%E9%A2%84%E6%B5%8B%E5%9F%BA%E5%9B%A0"><span class="nav-number">6.8.1.</span> <span class="nav-text">序列拆分并行预测基因</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E5%9B%A0%E5%8E%BB%E5%86%97%E4%BD%99cd-hit"><span class="nav-number">6.9.</span> <span class="nav-text">基因去冗余cd-hit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E6%89%B9%E5%9F%BA%E5%9B%A0%E5%90%88%E5%B9%B6cd-hit-est-2d"><span class="nav-number">6.9.1.</span> <span class="nav-text">两批基因合并cd-hit-est-2d</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cd-hit%E5%90%88%E5%B9%B6%E5%A4%9A%E6%89%B9%E5%9F%BA%E5%9B%A0salmon%E7%B4%A2%E5%BC%95%E6%97%B6%E6%8F%90%E7%A4%BAID%E9%87%8D%E5%A4%8D"><span class="nav-number">6.9.2.</span> <span class="nav-text">cd-hit合并多批基因salmon索引时提示ID重复</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E5%9B%A0%E5%AE%9A%E9%87%8Fsalmon"><span class="nav-number">6.10.</span> <span class="nav-text">基因定量salmon</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%BE%E4%B8%8D%E5%88%B0%E5%BA%93%E6%96%87%E4%BB%B6liblzma-so-0"><span class="nav-number">6.10.1.</span> <span class="nav-text">找不到库文件liblzma.so.0</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E5%9B%A0%E5%8A%9F%E8%83%BD%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">6.11.</span> <span class="nav-text">基因功能数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%BC%E5%90%88%E5%8A%9F%E8%83%BD%E6%B3%A8%E9%87%8AKEGG%E6%8F%8F%E8%BF%B0%E6%95%B4%E7%90%86"><span class="nav-number">6.11.1.</span> <span class="nav-text">综合功能注释KEGG描述整理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%97%E7%94%9F%E7%B4%A0%E6%8A%97%E6%80%A7CARD"><span class="nav-number">6.11.2.</span> <span class="nav-text">抗生素抗性CARD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%97%E7%94%9F%E7%B4%A0%E6%8A%97%E6%80%A7ResFam"><span class="nav-number">6.11.3.</span> <span class="nav-text">抗生素抗性ResFam</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%86%E8%8F%8C%E5%9F%BA%E5%9B%A0%E7%BB%84%E7%89%A9%E7%A7%8D%E6%B3%A8%E9%87%8AGTDB"><span class="nav-number">6.12.</span> <span class="nav-text">细菌基因组物种注释GTDB</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="nav-number">7.</span> <span class="nav-text">版本更新记录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-08-2020-7-20"><span class="nav-number">7.1.</span> <span class="nav-text">1.08 2020.7.20</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-09-2020-10-16"><span class="nav-number">7.2.</span> <span class="nav-text">1.09 2020.10.16</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-10-2021-1-22"><span class="nav-number">7.3.</span> <span class="nav-text">1.10 2021.1.22</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-11-2021-5-7"><span class="nav-number">7.4.</span> <span class="nav-text">1.11 2021.5.7</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-12-2021-8-20"><span class="nav-number">7.4.0.1.</span> <span class="nav-text">1.12 2021.8.20</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-13-2021-11-19"><span class="nav-number">7.4.0.2.</span> <span class="nav-text">1.13 2021.11.19</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-14-2022-3-25"><span class="nav-number">7.4.0.3.</span> <span class="nav-text">1.14 2022.3.25</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZEK YL"
      src="https://raw.githubusercontent.com/Zhang-EK/blog_img/main/WechatIMG22.jpeg">
  <p class="site-author-name" itemprop="name">ZEK YL</p>
  <div class="site-description" itemprop="description">2019.10.16</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Zhang-EK" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Zhang-EK" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhangerkang73@gmail.com" title="E-Mail → mailto:zhangerkang73@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://scholar.google.com.hk/citations?user=e3kZB8YAAAAJ&hl=zh-CN" title="Google学术 → https:&#x2F;&#x2F;scholar.google.com.hk&#x2F;citations?user&#x3D;e3kZB8YAAAAJ&amp;hl&#x3D;zh-CN" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZEK YL</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
